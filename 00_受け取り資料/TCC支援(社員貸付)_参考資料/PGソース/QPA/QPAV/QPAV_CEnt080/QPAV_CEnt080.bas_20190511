Attribute VB_Name = "MainModule"
Option Explicit
Public Const cpubMyPrjName = "QPAV_CEnt080" 'プログラム名
Public Const gcnsNumeric = "0123456789"     '入力文字制御用
Public Const gcnsstrSysChng = "2001/11/01"    '新システム以降日

Public lngErrCode             As Long       'エラーコード
Public strErrDescription      As String     'エラーメッセージ
Public gblnExecute            As Boolean    '子画面で実行されたか判定用
Public gblnHaitaFlg           As Boolean    '排他判定用フラグ
Public gstrSysDate            As String     'サーバーシステム日付
Public gblnNayoseFlg          As Boolean    '名寄せ検索画面起動フラグ
Public glngSPCount            As Long       '
Public gstrKeyInfo1           As String     '排他用キー情報(社員コード１)
Public gstrKeyInfo2           As String     '排他用キー情報(社員コード２)
Public glngSprRow             As Long       'スプレッド列
Public gstrMiseName           As String     '店名称
Public gstrSeisanYMD          As String     '精算年月日
Public gstrSyori              As String     '処理名称
Public gstrYuusiDat           As String     '融資データ（区切り文字入り）
Public gstrBonusMD1           As String     'ボーナス支払日１
Public gstrBonusMD2           As String     'ボーナス支払日２
Public glngSyosyoGendogaku    As Long       '証書限度額

'--SP用変数--
Public gstrSyainCd1           As String     '社員コード１(1桁)
Public gstrSyainCd2           As String     '社員コード２(7桁)
Public gstrSyainName          As String     '社員氏名
Public gstrYusiYMD            As String     '融資日
Public gstrGendogaku          As String     '限度額
Public gstrSyubetu            As String     '種別(融資区分)
Public gstrRiritu             As String     '利率
Public gstrHensaiTukisu       As String     '返済月数
Public gstrKyuyoHensaiAll     As String     '給与返済総額
Public gstrKyuyoHensai        As String     '給与返済額
Public gstrSyoyoHensaiAll     As String     '賞与返済総額
Public gstrSyoyoHensai        As String     '賞与返済額
Public gstrKyuyoZandaka       As String     '給与残高
Public gstrSyoyoZandaka       As String     '賞与残高
Public gstrKojoChusiFlg       As String     '控除中止フラグ
Public gstrKansaiYMD          As String     '完済日

Public gstrSyoyoHensaigaku    As String     '給与月々返済額
Public gstrKyuyoHensaigaku    As String     '賞与返済額

'--返済予定表計算用変数--
Type YoteiTbl
   intPageKbn                 As Integer    'ページ区分
   intNenKBN                  As Integer    '年区分
   strKbn                     As String     '区分
   strKijitu                  As String     '返済期日
   strHensai                  As String     '返済金額
   strZandaka                 As String     '残高
   strKyuGan                  As String     '給与元本
   strKyuRsk                  As String     '給与利息
   strKyuZan                  As String     '給与残高
   strSyoGan                  As String     '賞与元本
   strSyoRsk                  As String     '賞与利息
   strSyoZan                  As String     '賞与残高
End Type

Public gstrYoteihyouAry()  As YoteiTbl '予定表用配列
Public gstrYoteihyouSort() As YoteiTbl '予定表配列ソート用
'******************************************************************************
'*    起動 MAIN
'******************************************************************************
Public Sub Main()
 
 Dim strCmdLine As String
        
    '動作環境
    If App.PrevInstance Then
        MsgBox "社員融資台帳は既に起動されています。" _
            , vbExclamation Or vbOKOnly, cpubMyPrjName
        Exit Sub
    End If
    
    'コマンドライン引数の取得
    strCmdLine = Command()

    If strCmdLine = "" Then
        MsgBox "起動パラメータが設定されていません。" _
                , vbExclamation Or vbOKOnly, cpubMyPrjName

        Exit Sub
    End If

    'コマンドライン引数を編集する
    Call gsubGetCommandLine(strCmdLine)
    
    gblnHaitaFlg = False '排他判定用ﾌﾗｸﾞ初期化

    frmQPAV_CEnt080.Show 1
 
End Sub
'******************************************************************************
'*    排他解除
'******************************************************************************
Public Sub gsubUnLock()
 Dim strSQL As String
 
On Error GoTo errgsubUnLock

    odbDatabase.Parameters.Add "InstrSikibetu", "080", ORAPARM_INPUT                  '識別コード
    odbDatabase.Parameters.Add "InstrComputerMei", gstrCommandLine(5), ORAPARM_INPUT  'コンピューター名

    'SQL文作成
             strSQL = "BEGIN QPAP_CEnt080PkG.QPAP_CEnt080UnLock("
    strSQL = strSQL & " :InstrSikibetu"
    strSQL = strSQL & ",:InstrComputerMei);END;"

    'SP実行
    odbDatabase.DbexecuteSQL (strSQL)

    'オブジェクトの開放
    Call gsubParaRemove(odbDatabase)
        
    gblnHaitaFlg = False
        
    Exit Sub
    
errgsubUnLock:
'エラー処理
    
    'エラーメッセージ表示
    Call gsubDBErrorMessage(gstrCommandLine(8), cpubMyPrjName, _
                           gstrCommandLine(3), gstrCommandLine(5), gstrGetErrDateFormat)
    'オブジェクトの開放
    Call gsubParaRemove(odbDatabase)

End Sub
'******************************************************************************
'*    排他制御
'******************************************************************************
Public Function gblnHaita() As Boolean
 Dim strSQL As String
 
On Error GoTo errgblnHaita

    gblnHaita = False
    
    odbDatabase.Parameters.Add "InstrSikibetu", "080", ORAPARM_INPUT                  '識別コード
    odbDatabase.Parameters.Add "InstrProgramID", cpubMyPrjName, ORAPARM_INPUT         'プログラムＩＤ
    odbDatabase.Parameters.Add "InstrKeyInfo1", gstrKeyInfo1, ORAPARM_INPUT           'キー情報(社員コード１)
    odbDatabase.Parameters.Add "InstrKeyInfo2", gstrKeyInfo2, ORAPARM_INPUT           'キー情報(社員コード２)
    odbDatabase.Parameters.Add "InstrComputerMei", gstrCommandLine(5), ORAPARM_INPUT  'コンピュータ名
    odbDatabase.Parameters.Add "InstrOperatorID", gstrCommandLine(1), ORAPARM_INPUT   'オペレータＩＤ

    'SQL文作成
             strSQL = "BEGIN QPAP_CEnt080PkG.QPAP_CEnt080Lock("
    strSQL = strSQL & " :InstrSikibetu"
    strSQL = strSQL & ",:InstrProgramID"
    strSQL = strSQL & ",:InstrKeyInfo1"
    strSQL = strSQL & ",:InstrKeyInfo2"
    strSQL = strSQL & ",:InstrComputerMei"
    strSQL = strSQL & ",:InstrOperatorID);END;"

    'SP実行
    odbDatabase.DbexecuteSQL (strSQL)

    'オブジェクトの開放
    Call gsubParaRemove(odbDatabase)
    
    gblnHaita = True
    
    Exit Function
    
errgblnHaita:
'エラー処理
    
    '排他処理中エラーメッセージ表示
    If odbDatabase.LastServerErr >= 20000 Then   'Msg = 他の端末で処理中です。再度実行して下さい
'        frmQPAV_CEnt080!lblMsg.Caption = "WHOE11 " & gstrGetCodeMeisyo(odbDatabase, "E11", "WHO")  '【Win2000対応】Del by Yokoyama@NBC 2004/04/16
        frmQPAV_CEnt080.lblMsg.Caption = "WHOE11 " & gstrGetCodeMeisyo(odbDatabase, "E11", "WHO")   '【Win2000対応】Add by Yokoyama@NBC 2004/04/16
        
        odbDatabase.LastServerErrReset                      'ｴﾗｰﾘｾｯﾄ
        
        gblnHaitaFlg = True
    Else
        'エラーメッセージ表示
       Call gsubDBErrorMessage(gstrCommandLine(8), cpubMyPrjName, _
                              gstrCommandLine(3), gstrCommandLine(5), gstrGetErrDateFormat)
    End If
                           
    'オブジェクトの開放
    Call gsubParaRemove(odbDatabase)

End Function
'******************************************************************************
'*    初期処理用SP (システム日付)
'******************************************************************************
Public Sub gsubSPInit()
 Dim strSQL As String
 
On Error GoTo errSPInit
 
    'システム日付
    odbDatabase.Parameters.Add "OtStrSysDate", Space(8), ORAPARM_OUTPUT
    odbDatabase.Parameters("OtStrSysDate").ServerType = ORATYPE_VARCHAR2
    
    'SQL文の作成
             strSQL = "BEGIN QPAP_CEnt080PkG.QPAP_CEnt080Init("
    strSQL = strSQL & " :OtStrSysDate); END;"
            
    'SP実行
    odbDatabase.DbexecuteSQL (strSQL)
            
    gstrSysDate = odbDatabase.Parameters("OtStrSysDate")
        
    'オブジェクトの開放
    Call gsubParaRemove(odbDatabase)
    
    Exit Sub
            
errSPInit:
'エラー処理
    
    'エラーメッセージ表示
    Call gsubDBErrorMessage(gstrCommandLine(8), cpubMyPrjName, _
                           gstrCommandLine(3), gstrCommandLine(5), gstrGetErrDateFormat)
    'オブジェクトの開放
    Call gsubParaRemove(odbDatabase)
        
End Sub
'******************************************************************************
'*    返済予定表明細作成 (旧処理　融資日が 2000/03/01 以前の処理)
'******************************************************************************
Public Sub gSubMakeMeisaiKyuu()
 Dim strYuusibi         As String  '融資日
 Dim dblRiritu          As Double  '契約利率
 Dim intHensaiTuki      As Integer '返済月数
 Dim lngKyuuyoHensaiAll As Long    '給与返済額(総額)
 Dim lngSyouyoHensaiAll As Long    '賞与返済額(総額)
 Dim strSyouyoDate1     As String  '賞与支払日１
 Dim strSyouyoDate2     As String  '賞与支払日２

'--ワーク---------------------
 Dim i                       As Integer
 Dim intKyuuyoCNT            As Integer  ' 給与が第何回目かの数字
 Dim intSyouyoCNT            As Integer  ' 賞与が第何回目かの数字
 Dim intNenKBN               As Integer  '年区分
 Dim intKBN                  As Integer  '区分
 Dim strHensaiKijitu         As String   '返済期日
 Dim strSyouyoKijitu         As String   '賞与期日
 Dim lngKyuuyoTeigaku        As Long     '給与定額返済額_WORK
 Dim lngKyuuyoZan_1          As Long     '給与第1残高_WORK
 Dim lngKyuuyoHensaiZandaka  As Long     '給与返済残高
 Dim lngSyouyoTeigaku        As Long     '賞与定額返済額_WORK
 Dim lngSyouyoZan_1          As Long     '賞与第1残高_WORK
 Dim lngSyouyoHensaiZandaka  As Long     '賞与返済残高
 Dim curTeigaku_0            As Currency '定額_WORK0
 Dim curTeigaku_1            As Currency '定額_WORK1
 Dim curTeigaku_2            As Currency '定額_WORK2
 Dim intSyouyoHensaiKaisuu   As Integer  '賞与返済回数
 Dim strSyouyoSiharaiTuki    As String   '賞与支払月
 Dim strHensaiKijitu2        As String   '返済期日2
 Dim intHensaiKikan          As Integer  '返済期間
 Dim strZenkaiSyouyoHensaiBi As String   '前回賞与返済日
 Dim intSyouyoHensaiKikan    As Integer  '賞与返済期間
 Dim dblRisoku1              As Double   '利息
 Dim dblRisoku2              As Double   '利息２
 Dim dblKeiyakuriritu        As Double   '契約利率WK

 Dim Y As Integer
    
 Dim intNenKBN_WK           As Integer

 'ソート時に使用
 Dim lngSortKey()       As Long

On Error GoTo asd

    '変数にセット
    strYuusibi = Format$(Mid$(gstrYusiYMD, 1, 4) & "/" & Mid$(gstrYusiYMD, 5, 2) & "/" & Mid$(gstrYusiYMD, 7, 2), "YYYY/MM/DD") '融資日
    dblRiritu = CDbl(gstrRiritu) * 0.01            '契約利率
    intHensaiTuki = CInt(gstrHensaiTukisu)               '返済月数
    lngKyuuyoHensaiAll = CLng(gstrKyuyoHensaiAll)          '給与返済額(総額)
    lngSyouyoHensaiAll = CLng(gstrSyoyoHensaiAll)         '賞与返済額(総額)
''''    gstrBonusMD1 = Format$(Left$(gstrBonusMD1, 2) & Right$(gstrBonusMD1, 2), "MMDD")                  '賞与支払月日１
''''    gstrBonusMD2 = Format$(Left$(gstrBonusMD2, 2) & Right$(gstrBonusMD2, 2), "MMDD")                  '賞与支払月日2
''''    lngKyuuyoHensai = CLng(gfncstrDlm2(gstrYuusiDat, 9))             '毎月給与返済額
''''    lngSyouyoHensai = CLng(gfncstrDlm2(gstrYuusiDat, 11))            '毎月賞与返済額
    
''''''''2001/11/28
''''    '賞与支払日判定
''''''    If Format(Date, "MMDD") < gstrBonusMD1 Then
''''    If Format(Date, "MMDD") <= gstrBonusMD1 Then
''''        '賞与支払月日２を賞与支払月日１に
''''''        strSyouyoDate1 = Format$(Date, "YYYY") & "/" & gstrBonusMD2
''''''        strSyouyoDate2 = Format$(DateAdd("YYYY", -1, Date), "YYYY") & "/" & gstrBonusMD1
''''        strSyouyoDate1 = Format$(Date, "YYYY") & "/" & Left$(gstrBonusMD1, 2) & "/" & Right$(gstrBonusMD1, 2)
''''        strSyouyoDate2 = Format$(DateAdd("YYYY", 0, Date), "YYYY") & "/" & Left$(gstrBonusMD2, 2) & "/" & Right$(gstrBonusMD2, 2)
'''''    ElseIf Format(Date, "MMDD") > gstrBonusMD2 Then
''''    ElseIf Format(Date, "MMDD") >= gstrBonusMD2 Then
''''        '賞与支払月日２を賞与支払月日１に
''''''        strSyouyoDate1 = Format$(Date, "YYYY") & "/" & gstrBonusMD2
''''''        strSyouyoDate2 = Format$(DateAdd("YYYY", -1, Date), "YYYY") & "/" & gstrBonusMD1
''''        strSyouyoDate1 = Format$(Date, "YYYY") & "/" & Left$(gstrBonusMD2, 2) & "/" & Right$(gstrBonusMD2, 2)
''''        strSyouyoDate2 = Format$(DateAdd("YYYY", 0, Date), "YYYY") & "/" & Left$(gstrBonusMD1, 2) & "/" & Right$(gstrBonusMD1, 2)
''''    ElseIf Format(Date, "MMDD") > gstrBonusMD1 And Format(Date, "MMDD") < gstrBonusMD2 Then
''''        strSyouyoDate1 = Format$(Date, "YYYY") & "/" & Left$(gstrBonusMD1, 2) & "/" & Right$(gstrBonusMD1, 2)
''''        strSyouyoDate2 = Format$(Date, "YYYY") & "/" & Left$(gstrBonusMD2, 2) & "/" & Right$(gstrBonusMD2, 2)
''''    End If
    If Format(strYuusibi, "MMDD") >= gstrBonusMD1 Then
        If Format(strYuusibi, "MMDD") >= gstrBonusMD2 Then
            strSyouyoDate1 = Format$(DateAdd("yyyy", 1, strYuusibi), "YYYY") & "/" & Left$(gstrBonusMD1, 2) & "/" & Right$(gstrBonusMD1, 2)
            strSyouyoDate2 = Format$(DateAdd("yyyy", 1, strYuusibi), "YYYY") & "/" & Left$(gstrBonusMD2, 2) & "/" & Right$(gstrBonusMD2, 2)
        Else
            If Format(strYuusibi, "MM") = Left(gstrBonusMD2, 2) Then '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''2001/12/12追加
                strSyouyoDate1 = Format$(DateAdd("yyyy", 1, strYuusibi), "YYYY") & "/" & Left$(gstrBonusMD1, 2) & "/" & Right$(gstrBonusMD1, 2) ''''2001/12/12追加'
                strSyouyoDate2 = Format$(DateAdd("yyyy", 1, strYuusibi), "YYYY") & "/" & Left$(gstrBonusMD2, 2) & "/" & Right$(gstrBonusMD2, 2) ''''2001/12/12追加
            Else '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''2001/12/12追加
                strSyouyoDate1 = Format$(DateAdd("yyyy", 0, strYuusibi), "YYYY") & "/" & Left$(gstrBonusMD2, 2) & "/" & Right$(gstrBonusMD2, 2)
                strSyouyoDate2 = Format$(DateAdd("yyyy", 1, strYuusibi), "YYYY") & "/" & Left$(gstrBonusMD1, 2) & "/" & Right$(gstrBonusMD1, 2)
            End If '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''2001/12/12追加
        End If
    Else
        If Format(strYuusibi, "MM") = Left(gstrBonusMD1, 2) Then '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''2001/12/12追加
            strSyouyoDate1 = Format$(DateAdd("yyyy", 0, strYuusibi), "YYYY") & "/" & Left$(gstrBonusMD2, 2) & "/" & Right$(gstrBonusMD2, 2) ''''2001/12/12追加
            strSyouyoDate2 = Format$(DateAdd("yyyy", 1, strYuusibi), "YYYY") & "/" & Left$(gstrBonusMD1, 2) & "/" & Right$(gstrBonusMD1, 2) ''''2001/12/12追加
        Else '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''2001/12/12追加
            strSyouyoDate1 = Format$(DateAdd("yyyy", 0, strYuusibi), "YYYY") & "/" & Left$(gstrBonusMD1, 2) & "/" & Right$(gstrBonusMD1, 2)
            strSyouyoDate2 = Format$(DateAdd("yyyy", 0, strYuusibi), "YYYY") & "/" & Left$(gstrBonusMD2, 2) & "/" & Right$(gstrBonusMD2, 2)
        End If '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''2001/12/12追加
    End If


    intSyouyoHensaiKikan = DateDiff("M", strSyouyoDate1, strSyouyoDate2)
    strZenkaiSyouyoHensaiBi = strYuusibi

    intNenKBN = 1
    intKyuuyoCNT = 1
    intSyouyoCNT = 1
    
    If intHensaiTuki <= 0 Then
        intHensaiTuki = 1
    End If
    
    '賞与返済回数
    intSyouyoHensaiKaisuu = Fix(intHensaiTuki / 6)
    For i = 1 To intHensaiTuki Mod 6
        If DatePart("M", DateAdd("M", i, strYuusibi)) = DatePart("M", strSyouyoDate1) Or DatePart("M", DateAdd("M", i, strYuusibi)) = DatePart("M", strSyouyoDate2) Then
            intSyouyoHensaiKaisuu = intSyouyoHensaiKaisuu + 1
        End If
    Next i
    If intSyouyoHensaiKaisuu <= 0 Then
        intSyouyoHensaiKaisuu = 1
    End If
  
    strHensaiKijitu = DateAdd("M", 1, CVDate(Format$(strYuusibi, "YYYY/MM/25")))
  
    If DateDiff("Y", strYuusibi, DateAdd("Y", -1, CVDate(Format$(strYuusibi, "YYYY/") & Format$(strSyouyoDate1, "MM") & "/01"))) >= 0 Then     '一ヶ月前
        strSyouyoKijitu = CVDate(Format$(strYuusibi, "YYYY/") & Format$(strSyouyoDate1, "MM/dd"))
    ElseIf DateDiff("Y", strYuusibi, DateAdd("Y", -1, CVDate(Format$(strYuusibi, "YYYY/") & Format$(strSyouyoDate2, "MM") & "/01"))) >= 0 Then '一ヶ月前
        strSyouyoKijitu = CVDate(Format$(strYuusibi, "YYYY/") & Format$(strSyouyoDate2, "MM/dd"))
    Else
        strSyouyoKijitu = DateAdd("YYYY", 1, CVDate(Format$(strYuusibi, "YYYY/") & Format$(strSyouyoDate1, "MM/dd")))
    End If

    lngKyuuyoHensaiZandaka = lngKyuuyoHensaiAll
    lngSyouyoHensaiZandaka = lngSyouyoHensaiAll

    '----------------------毎月支払額計算---------------------------
    If Val(Format(strYuusibi, "dd")) >= 11 Then
        intHensaiKikan = 30
    Else
        intHensaiKikan = 45
    End If
    dblRisoku2 = (lngKyuuyoHensaiAll * dblRiritu * intHensaiKikan / 12 / 30)
    dblRisoku1 = Int(dblRisoku2)
    If intHensaiTuki <= 1 Then
        lngKyuuyoTeigaku = dblRisoku1 + lngKyuuyoHensaiAll
    Else
        curTeigaku_0 = 0
        curTeigaku_1 = Abs(-Pmt(dblRiritu / 12, intHensaiTuki - 1, lngKyuuyoHensaiAll, 0, 0))
        curTeigaku_2 = Abs(-Pmt(dblRiritu / 12, intHensaiTuki - 1, lngKyuuyoHensaiAll - curTeigaku_1 + dblRisoku2, 0, 0))
        While Abs(curTeigaku_1 - curTeigaku_2) > 0.001 Or Abs(curTeigaku_0 - curTeigaku_2) > 0.001
            curTeigaku_0 = curTeigaku_1: curTeigaku_1 = curTeigaku_2
            curTeigaku_2 = Abs(-Pmt(dblRiritu / 12, intHensaiTuki - 1, lngKyuuyoHensaiAll - (((curTeigaku_0) + (curTeigaku_1)) / 2) + dblRisoku2, 0, 0))
        Wend
        lngKyuuyoTeigaku = Fix(Abs(((curTeigaku_0) + (curTeigaku_1) + (curTeigaku_2)) / 3))
    End If

    If intSyouyoHensaiKikan = 6 Then
        If Month(DateAdd("Y", 1, strSyouyoKijitu)) <> Month(strSyouyoKijitu) Then
            dblRisoku2 = (lngSyouyoHensaiAll * dblRiritu * (DateDiff("M", strYuusibi, strSyouyoKijitu) * 30 + IIf(Val(Format(strYuusibi, "dd")) >= 11, 6, 21)) / 2 / 180)
        Else
            dblRisoku2 = (lngSyouyoHensaiAll * dblRiritu * (DateDiff("M", strYuusibi, strSyouyoKijitu) * 30 + IIf(Val(Format(strYuusibi, "dd")) >= 11, 6, 21) + (Day(strSyouyoKijitu) - 1 - 30)) / 2 / 180)
        End If
        dblRisoku1 = Int(dblRisoku2)
    Else
        dblRisoku2 = (lngSyouyoHensaiAll * dblRiritu * (DateDiff("M", strYuusibi, strSyouyoKijitu) * 30 + IIf(Val(Format(strYuusibi, "dd")) >= 11, 6, 21) + ((10) - 1 - 30)) / 2 / 180)
        dblRisoku1 = Int(dblRisoku2)
    End If

    If intSyouyoHensaiKaisuu <= 1 Then
        lngSyouyoTeigaku = dblRisoku1 + lngSyouyoHensaiAll
    Else
        curTeigaku_0 = 0
        curTeigaku_1 = Abs(-Pmt(dblRiritu / 2, intSyouyoHensaiKaisuu - 1, lngSyouyoHensaiAll, 0, 0))
        curTeigaku_2 = Abs(-Pmt(dblRiritu / 2, intSyouyoHensaiKaisuu - 1, lngSyouyoHensaiAll - curTeigaku_1 + dblRisoku2, 0, 0))
        While Abs(curTeigaku_1 - curTeigaku_2) > 0.001 Or Abs(curTeigaku_0 - curTeigaku_2) > 0.001
            curTeigaku_0 = curTeigaku_1: curTeigaku_1 = curTeigaku_2
            curTeigaku_2 = Abs(-Pmt(dblRiritu / 2, intSyouyoHensaiKaisuu - 1, lngSyouyoHensaiAll - (((curTeigaku_0) + (curTeigaku_1)) / 2) + dblRisoku2, 0, 0))
        Wend
        lngSyouyoTeigaku = Fix(Abs(((curTeigaku_0) + (curTeigaku_1) + (curTeigaku_2)) / 3))
        If intSyouyoHensaiKikan <> 6 Then
            lngSyouyoTeigaku = gfnclngSyouyoHensai(CDbl(CDate(strYuusibi)), dblRiritu, strSyouyoDate1, strSyouyoDate2, intSyouyoHensaiKaisuu, lngSyouyoHensaiAll, dblRisoku1, lngSyouyoTeigaku)
        End If
    End If
    '-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
    
    '◆ワークテーブル登録用データ作成
    i = 1
    
    '* １回目の給与返済用のデータを追加する
    If lngKyuuyoHensaiZandaka > 0 Then
        ReDim Preserve gstrYoteihyouAry(i)
        With gstrYoteihyouAry(i)
            .intPageKbn = Fix((intNenKBN + 2) / 3) ''''''''''''''''''''''''''''''''''''''''''''''''''ページ区分
            .intNenKBN = intNenKBN ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''年区分
            .strKbn = "給与" & Space$(3 - Len(Format$(1, "###"))) & Format$(1, "###") '''''''''''''''区分
            
            
            .strKijitu = gvarCnvDate(1, strHensaiKijitu) ''''''''''''''''''''''''''''''''''''''''''''返済期日
            If strYuusibi < "2000/03/01" Then
                If Mid$(.strKijitu, 1, 2) > "11" Then
                    If Mid$(.strKijitu, 4, 5) = " 4.30" Then
                        .strKijitu = Mid$(.strKijitu, 1, 2) & ". 6.15"                                      '04 返済期日
                    ElseIf Mid$(.strKijitu, 4, 5) = "10.31" Then
                        .strKijitu = Mid$(.strKijitu, 1, 2) & ".12. 1"        '04 返済期日
                    End If
                End If
            End If
            
            .strHensai = lngKyuuyoTeigaku '固定 '''''''''''''''''''''''''''''''''''''''''''''''''''''返済金額
            If Val(Format(strYuusibi, "dd")) >= 11 Then
                intHensaiKikan = 30
            Else
                intHensaiKikan = 45
            End If
            dblKeiyakuriritu = dblRiritu * 100
            .strKyuRsk = Fix(lngKyuuyoHensaiAll * dblKeiyakuriritu * intHensaiKikan / 12 / 3000)
            .strKyuGan = .strHensai - .strKyuRsk
            If intHensaiTuki = 1 Then
                .strKyuGan = lngKyuuyoHensaiZandaka '''''''''''''''''''''''''''''''''''''''''''''''''給与元本
                .strHensai = lngKyuuyoHensaiZandaka + .strKyuRsk ''''''''''''''''''''''''''''''''''''返済金額
            End If
            lngKyuuyoHensaiZandaka = lngKyuuyoHensaiZandaka - .strKyuGan '給与返済残高 計算
            .strKyuZan = lngKyuuyoHensaiZandaka '''''''''''''''''''''''''''''''''''''''''''''''''''''給与残高
            lngKyuuyoZan_1 = .strKyuZan
            .strZandaka = " "   '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''残高
            .strSyoGan = " " ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''賞与元本
            .strSyoRsk = " " ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''賞与利息
            .strSyoZan = " " ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''賞与残高
            intKyuuyoCNT = intKyuuyoCNT + 1
            i = i + 1
        End With
    End If
    
    '* １回目の給与返済月と賞与返済月が一致する場合、１回目の賞与返済用のデータを追加する
    If (DatePart("M", strHensaiKijitu) = DatePart("M", strSyouyoDate1) Or DatePart("M", strHensaiKijitu) = DatePart("M", strSyouyoDate2)) And lngSyouyoHensaiZandaka > 0 Then
        ReDim Preserve gstrYoteihyouAry(i)
        With gstrYoteihyouAry(i)
            If lngKyuuyoTeigaku > 0 Then
                .intPageKbn = Fix((intNenKBN + 2) / 3)
            Else
                .intPageKbn = 1 ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''ページ区分
            End If
            .intNenKBN = intNenKBN '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''年区分
            .strKbn = "賞与" & String$(3 - Len(Format$(intSyouyoCNT, "###")), "*") & Format$(intSyouyoCNT, "###") ''''''''''''区分
            
            .strKijitu = gvarCnvDate(1, strSyouyoKijitu) '''''''''''''''''''''''''''''''''''''''''''''''返済期日
            If strYuusibi < "2000/03/01" Then
                If Mid$(.strKijitu, 1, 2) > "11" Then
                    If Mid$(.strKijitu, 4, 5) = " 4.30" Then
                        .strKijitu = Mid$(.strKijitu, 1, 2) & ". 6.15"                                      '04 返済期日
                    ElseIf Mid$(.strKijitu, 4, 5) = "10.31" Then
                        .strKijitu = Mid$(.strKijitu, 1, 2) & ".12. 1"        '04 返済期日
                    End If
                End If
            End If
            
            .strHensai = lngSyouyoTeigaku '固定（賞与）'''''''''''''''''''''''''''''''''''''''''''''''''返済金額
            If intSyouyoHensaiKikan = 6 Then
                If Month(DateAdd("Y", 1, strSyouyoKijitu)) <> Month(strSyouyoKijitu) Then
                    dblRisoku2 = lngSyouyoHensaiAll * dblRiritu * (DateDiff("M", strYuusibi, strSyouyoKijitu) * 30 + IIf(Val(Format(strYuusibi, "dd")) >= 11, 6, 21)) / 2 / 180
                    .strSyoRsk = Int(dblRisoku2) '''''''''''''''''''''''''''''''''''''''''''''''''''''''賞与利息
                Else
                    dblRisoku2 = lngSyouyoHensaiAll * dblRiritu * (DateDiff("M", strYuusibi, strSyouyoKijitu) * 30 + IIf(Val(Format(strYuusibi, "dd")) >= 11, 6, 21) + (Day(strSyouyoKijitu) - 1 - 30)) / 2 / 180
                    .strSyoRsk = Int(dblRisoku2) '''''''''''''''''''''''''''''''''''''''''''''''''''''''賞与利息
                End If
            Else
                dblRisoku2 = lngSyouyoHensaiAll * dblRiritu * (DateDiff("M", strYuusibi, strSyouyoKijitu) * 30 + IIf(Val(Format(strYuusibi, "dd")) >= 11, 6, 21) + ((10) - 1 - 30)) / 2 / 180
                .strSyoRsk = Int(dblRisoku2) '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''賞与利息
            End If
            .strSyoGan = .strHensai - .strSyoRsk '''''''''''''''''''''''''''''''''''''''''''''''''''''''賞与元本
            If intSyouyoHensaiKaisuu = 1 Then
                .strSyoGan = lngSyouyoHensaiZandaka ''''''''''''''''''''''''''''''''''''''''''''''''''''賞与元本
                .strHensai = lngSyouyoHensaiZandaka + .strSyoRsk '''''''''''''''''''''''''''''''''''''''返済金額
            End If
            lngSyouyoHensaiZandaka = lngSyouyoHensaiZandaka - .strSyoGan '賞与返済残高 計算
            .strSyoZan = lngSyouyoHensaiZandaka ''''''''''''''''''''''''''''''''''''''''''''''''''''''''賞与残高
            lngSyouyoZan_1 = .strSyoZan
            .strZandaka = " " ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''残高
            .strKyuGan = " " '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''給与元本
            .strKyuRsk = " " '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''給与利息
            .strKyuZan = " " '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''給与残高
            strZenkaiSyouyoHensaiBi = strSyouyoKijitu
            intSyouyoCNT = intSyouyoCNT + 1
            i = i + 1
        End With
    End If
    
    
    strHensaiKijitu2 = strHensaiKijitu
    strHensaiKijitu = DateAdd("M", 1, strHensaiKijitu)

    ' ◆◆２回目以降のデータ追加
    intNenKBN_WK = 2
    'While (I <= intHensaiTuki Or intSyouyoCNT <= intSyouyoHensaiKaisuu) And (lngKyuuyoHensaiZandaka > 0 Or lngSyouyoHensaiZandaka > 0)
    While (intKyuuyoCNT <= intHensaiTuki Or intSyouyoCNT <= intSyouyoHensaiKaisuu) And (lngKyuuyoHensaiZandaka > 0 Or lngSyouyoHensaiZandaka > 0)
        '* 給与のデータ追加
        If lngKyuuyoHensaiZandaka > 0 Then
            ReDim Preserve gstrYoteihyouAry(i)
            With gstrYoteihyouAry(i)
            
                .intPageKbn = Fix((intNenKBN + 2) / 3) '''''''''''''''''''''''''''''''''''''''''''''''''ページ区分
                .intNenKBN = intNenKBN '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''年区分
                .strKbn = "給与" & Space$(3 - Len(Format$(intKyuuyoCNT, "###"))) & Format$(intKyuuyoCNT, "###") ''''''''''''''区分
                
                .strKijitu = gvarCnvDate(1, strHensaiKijitu) '''''''''''''''''''''''''''''''''''''''''''返済期日
                If strYuusibi < "2000/03/01" Then
                    If Mid$(.strKijitu, 1, 2) > "11" Then
                        If Mid$(.strKijitu, 4, 5) = " 4.30" Then
                            .strKijitu = Mid$(.strKijitu, 1, 2) & ". 6.15"                                      '04 返済期日
                        ElseIf Mid$(.strKijitu, 4, 5) = "10.31" Then
                            .strKijitu = Mid$(.strKijitu, 1, 2) & ".12. 1"        '04 返済期日
                        End If
                    End If
                End If
                
                .strHensai = lngKyuuyoTeigaku '固定 ''''''''''''''''''''''''''''''''''''''''''''''''''''返済金額
                .strKyuRsk = Fix(lngKyuuyoHensaiZandaka * dblRiritu / 12) ''''''''''''''''''''''''''''''給与利息
                .strKyuGan = .strHensai - .strKyuRsk '''''''''''''''''''''''''''''''''''''''''''''''''''給与元本
                ' 最終回の場合
                If intHensaiTuki = intKyuuyoCNT Then
                    .strKyuGan = lngKyuuyoHensaiZandaka ''''''''''''''''''''''''''''''''''''''''''''''''給与元本
                    .strHensai = lngKyuuyoHensaiZandaka + .strKyuRsk '''''''''''''''''''''''''''''''''''返済金額
                End If
                lngKyuuyoHensaiZandaka = lngKyuuyoHensaiZandaka - .strKyuGan '給与返済残高 計算
                .strKyuZan = lngKyuuyoHensaiZandaka ''''''''''''''''''''''''''''''''''''''''''''''''''''給与残高
                .strZandaka = " " ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''返済残高
                .strSyoGan = " " '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''賞与元本
                .strSyoRsk = " " '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''賞与利息
                .strSyoZan = " " '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''賞与残高
                intKyuuyoCNT = intKyuuyoCNT + 1
                i = i + 1
            End With
        End If
        
        '* 当該月と賞与返済月が一致する場合、賞与返済用のデータも追加する
        If (DatePart("M", strHensaiKijitu) = DatePart("M", strSyouyoDate1) Or DatePart("M", strHensaiKijitu) = DatePart("M", strSyouyoDate2)) And lngSyouyoHensaiZandaka > 0 Then
            ReDim Preserve gstrYoteihyouAry(i)
            With gstrYoteihyouAry(i)
                
                If lngKyuuyoTeigaku > 0 Then
                    .intPageKbn = Fix((intNenKBN + 2) / 3) '''''''''''''''''''''''''''''''''''''''''''''ページ区分
                Else
                    .intPageKbn = 1 ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''ページ区分
                End If
                .intNenKBN = intNenKBN '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''年区分
                .strKbn = "賞与" & String$(3 - Len(Format$(intSyouyoCNT, "###")), "*") & Format$(intSyouyoCNT, "###") ''''''''区分
                '* 今回の賞与返済日の算出
                If Month(strHensaiKijitu) = Month(strSyouyoDate1) Then
                    strSyouyoKijitu = CVDate(Format$(strHensaiKijitu, "YYYY/") & Format$(strSyouyoDate1, "MM/dd"))
                Else
                    strSyouyoKijitu = CVDate(Format$(strHensaiKijitu, "YYYY/") & Format$(strSyouyoDate2, "MM/dd"))
               End If
                .strKijitu = gvarCnvDate(1, strSyouyoKijitu) '''''''''''''''''''''''''''''''''''''''''''返済期日
                
                .strKijitu = gvarCnvDate(1, strSyouyoKijitu) '''''''''''''''''''''''''''''''''''''''''''返済期日
                If strYuusibi < "2000/03/01" Then
                    If Mid$(.strKijitu, 1, 2) > "11" Then
                        If Mid$(.strKijitu, 4, 5) = " 4.30" Then
                            .strKijitu = Mid$(.strKijitu, 1, 2) & ". 6.15"                                      '04 返済期日
                        ElseIf Mid$(.strKijitu, 4, 5) = "10.31" Then
                            .strKijitu = Mid$(.strKijitu, 1, 2) & ".12. 1"        '04 返済期日
                        End If
                    End If
                End If
                
                .strHensai = lngSyouyoTeigaku '固定（賞与）'''''''''''''''''''''''''''''''''''''''''''''返済金額
                If intSyouyoHensaiKikan = 6 Then
                    If intSyouyoCNT = 1 Then
                        If Month(DateAdd("Y", 1, strSyouyoKijitu)) <> Month(strSyouyoKijitu) Then
                            dblRisoku2 = lngSyouyoHensaiAll * dblRiritu * (DateDiff("M", strYuusibi, strSyouyoKijitu) * 30 + IIf(Val(Format(strYuusibi, "dd")) >= 11, 6, 21)) / 2 / 180        '初回利息
                            .strSyoRsk = Int(dblRisoku2) '''''''''''''''''''''''''''''''''''''''''''''''賞与利息
                        Else
                            dblRisoku2 = lngSyouyoHensaiAll * dblRiritu * (DateDiff("M", strYuusibi, strSyouyoKijitu) * 30 + IIf(Val(Format(strYuusibi, "dd")) >= 11, 6, 21) + (Day(strSyouyoKijitu) - 1 - 30)) / 2 / 180 '初回利息
                            .strSyoRsk = Int(dblRisoku2) '''''''''''''''''''''''''''''''''''''''''''''''賞与利息
                        End If
                    Else
                        dblRisoku2 = lngSyouyoHensaiZandaka * dblRiritu / 2
                        .strSyoRsk = Int(dblRisoku2) '''''''''''''''''''''''''''''''''''''''''''''''''''賞与利息
                    End If
                Else
                    If intSyouyoCNT = 1 Then
                        dblRisoku2 = lngSyouyoHensaiAll * dblRiritu * (DateDiff("M", strYuusibi, strSyouyoKijitu) * 30 + IIf(Val(Format(strYuusibi, "dd")) >= 11, 6, 21) + ((10) - 1 - 30)) / 2 / 180 '初回利息
                        .strSyoRsk = Int(dblRisoku2) '''''''''''''''''''''''''''''''''''''''''''''''''''賞与利息
                    Else
                        dblRisoku2 = lngSyouyoHensaiZandaka * dblRiritu * DateDiff("M", strZenkaiSyouyoHensaiBi, strSyouyoKijitu) / 12
                        .strSyoRsk = Int(dblRisoku2) '''''''''''''''''''''''''''''''''''''''''''''''''''賞与利息
                    End If
                End If
                .strSyoGan = .strHensai - .strSyoRsk '''''''''''''''''''''''''''''''''''''''''''''''''''賞与原本
                If intSyouyoHensaiKaisuu = intSyouyoCNT Then
                    .strSyoGan = lngSyouyoHensaiZandaka ''''''''''''''''''''''''''''''''''''''''''''''''賞与元本
                    .strHensai = lngSyouyoHensaiZandaka + .strSyoRsk '''''''''''''''''''''''''''''''''''返済金額
                End If
                lngSyouyoHensaiZandaka = lngSyouyoHensaiZandaka - .strSyoGan '賞与返済残高 計算
                .strSyoZan = lngSyouyoHensaiZandaka ''''''''''''''''''''''''''''''''''''''''''''''''''''賞与残高
                If intSyouyoCNT = 1 Then
                    lngKyuuyoZan_1 = .strSyoZan
                End If
                .strZandaka = " " '残高
                .strKyuGan = " " '給与元本
                .strKyuRsk = " " '給与利息
                .strKyuZan = " " '給与残高
                strZenkaiSyouyoHensaiBi = strSyouyoKijitu
                intSyouyoCNT = intSyouyoCNT + 1
                i = i + 1
            End With
        End If
        
        strHensaiKijitu2 = strHensaiKijitu
        strHensaiKijitu = DateAdd("M", 1, strHensaiKijitu)
        
        
''''2001/12/07  不要（表示のみ新賞与日、計算は旧賞与日で行う
''''        '↓↓↓2001/11/28 賞与日は2000/03を境に変わる↓↓↓
''''        If strYuusibi < "2000/03/01" Then
''''            If strHensaiKijitu > "2000/03/01" Then
''''                If strSyouyoDate1 > strSyouyoDate2 Then
''''                    strSyouyoDate1 = Mid$(strSyouyoDate1, 1, 5) & "12/01"
''''                    strSyouyoDate2 = Mid$(strSyouyoDate2, 1, 5) & "06/15"
''''                Else
''''                    strSyouyoDate1 = Mid$(strSyouyoDate1, 1, 5) & "06/15"
''''                    strSyouyoDate2 = Mid$(strSyouyoDate2, 1, 5) & "12/01"
''''                End If
''''            End If
''''        End If
''''        '↑↑↑2001/11/28 賞与日は2000/03を境に変わる↑↑↑
''''2001/12/07  不要（表示のみ新賞与日、計算は旧賞与日で行う
        
        
        ' １２回（次が賞与の時は、次の賞与まで含まれる）毎に、
        ' 返済予定表に罫線を出力させるための区分のカウントアップ
        If ((intNenKBN_WK) Mod 12) = 0 Then
            intNenKBN = intNenKBN + 1
        End If
        intNenKBN_WK = intNenKBN_WK + 1
    
    Wend
    
    '■gstrYoteihyouAry配列ソート...賞与データがずれているため■
    For Y = 1 To UBound(gstrYoteihyouAry)
        With gstrYoteihyouAry(Y)
            ReDim Preserve lngSortKey(Y)
            ReDim Preserve gstrYoteihyouSort(Y)
            lngSortKey(Y) = CLng(Format(Mid$(.strKijitu, 1, 2), "00") & Format(Mid$(.strKijitu, 4, 2), "00") & Format(Mid$(.strKijitu, 7, 2), "00"))
            gstrYoteihyouSort(Y).intNenKBN = gstrYoteihyouAry(Y).intNenKBN
            gstrYoteihyouSort(Y).intPageKbn = gstrYoteihyouAry(Y).intPageKbn
            gstrYoteihyouSort(Y).strHensai = gstrYoteihyouAry(Y).strHensai
            gstrYoteihyouSort(Y).strKbn = gstrYoteihyouAry(Y).strKbn
            gstrYoteihyouSort(Y).strKijitu = gstrYoteihyouAry(Y).strKijitu
            gstrYoteihyouSort(Y).strKyuGan = gstrYoteihyouAry(Y).strKyuGan
            gstrYoteihyouSort(Y).strKyuRsk = gstrYoteihyouAry(Y).strKyuRsk
            gstrYoteihyouSort(Y).strKyuZan = gstrYoteihyouAry(Y).strKyuZan
            gstrYoteihyouSort(Y).strSyoGan = gstrYoteihyouAry(Y).strSyoGan
            gstrYoteihyouSort(Y).strSyoRsk = gstrYoteihyouAry(Y).strSyoRsk
            gstrYoteihyouSort(Y).strSyoZan = gstrYoteihyouAry(Y).strSyoZan
            gstrYoteihyouSort(Y).strZandaka = gstrYoteihyouAry(Y).strZandaka
        End With
    Next Y
    
    For Y = 1 To UBound(gstrYoteihyouAry)
        If Y <> 1 Then
            If lngSortKey(Y) < lngSortKey(Y - 1) Then
                gstrYoteihyouAry(Y).intNenKBN = gstrYoteihyouSort(Y - 1).intNenKBN
                If gstrYoteihyouSort(Y).intNenKBN > gstrYoteihyouSort(Y - 1).intNenKBN Then
                    gstrYoteihyouAry(Y).intNenKBN = gstrYoteihyouAry(Y).intNenKBN + 1
                End If
                
                
                gstrYoteihyouAry(Y).intPageKbn = gstrYoteihyouSort(Y - 1).intPageKbn
                If gstrYoteihyouSort(Y).intPageKbn > gstrYoteihyouSort(Y - 1).intPageKbn Then
                    gstrYoteihyouAry(Y).intPageKbn = gstrYoteihyouAry(Y).intPageKbn + 1
                End If
                               
                gstrYoteihyouAry(Y).strHensai = gstrYoteihyouSort(Y - 1).strHensai
                gstrYoteihyouAry(Y).strKbn = gstrYoteihyouSort(Y - 1).strKbn
                gstrYoteihyouAry(Y).strKijitu = gstrYoteihyouSort(Y - 1).strKijitu
                gstrYoteihyouAry(Y).strKyuGan = gstrYoteihyouSort(Y - 1).strKyuGan
                gstrYoteihyouAry(Y).strKyuRsk = gstrYoteihyouSort(Y - 1).strKyuRsk
                gstrYoteihyouAry(Y).strKyuZan = gstrYoteihyouSort(Y - 1).strKyuZan
                gstrYoteihyouAry(Y).strSyoGan = gstrYoteihyouSort(Y - 1).strSyoGan
                gstrYoteihyouAry(Y).strSyoRsk = gstrYoteihyouSort(Y - 1).strSyoRsk
                gstrYoteihyouAry(Y).strSyoZan = gstrYoteihyouSort(Y - 1).strSyoZan
                gstrYoteihyouAry(Y).strZandaka = gstrYoteihyouSort(Y - 1).strZandaka
            
                gstrYoteihyouAry(Y - 1).intNenKBN = gstrYoteihyouSort(Y).intNenKBN
                gstrYoteihyouAry(Y - 1).intPageKbn = gstrYoteihyouSort(Y).intPageKbn
                gstrYoteihyouAry(Y - 1).strHensai = gstrYoteihyouSort(Y).strHensai
                gstrYoteihyouAry(Y - 1).strKbn = gstrYoteihyouSort(Y).strKbn
                gstrYoteihyouAry(Y - 1).strKijitu = gstrYoteihyouSort(Y).strKijitu
                gstrYoteihyouAry(Y - 1).strKyuGan = gstrYoteihyouSort(Y).strKyuGan
                gstrYoteihyouAry(Y - 1).strKyuRsk = gstrYoteihyouSort(Y).strKyuRsk
                gstrYoteihyouAry(Y - 1).strKyuZan = gstrYoteihyouSort(Y).strKyuZan
                gstrYoteihyouAry(Y - 1).strSyoGan = gstrYoteihyouSort(Y).strSyoGan
                gstrYoteihyouAry(Y - 1).strSyoRsk = gstrYoteihyouSort(Y).strSyoRsk
                gstrYoteihyouAry(Y - 1).strSyoZan = gstrYoteihyouSort(Y).strSyoZan
                gstrYoteihyouAry(Y - 1).strZandaka = gstrYoteihyouSort(Y).strZandaka
            End If
        End If
    Next Y

    '■残高算出■
    lngKyuuyoHensaiZandaka = lngKyuuyoHensaiAll
    lngSyouyoHensaiZandaka = lngSyouyoHensaiAll

    For Y = 1 To UBound(gstrYoteihyouAry)
        With gstrYoteihyouAry(Y)
            If Trim$(.strKyuZan) <> "" Then
                lngKyuuyoHensaiZandaka = .strKyuZan
            End If
            If Trim$(.strSyoZan) <> "" Then
                lngSyouyoHensaiZandaka = .strSyoZan
            End If
            .strZandaka = lngKyuuyoHensaiZandaka + lngSyouyoHensaiZandaka '残高
        End With
    Next Y

    Exit Sub

asd:
Exit Sub

End Sub
'******************************************************************************
'*    返済予定表明細作成_新 (融資日が2000/03/01以降の計算)
'******************************************************************************
Public Sub gSubMakeMeisai()
 Dim strYuusibi         As String  '融資日
 Dim dblRiritu          As Double  '契約利率
 Dim intHensaiTuki      As Integer '返済月数
 Dim lngKyuuyoHensaiAll      As Long    '給与返済額(総額)
 Dim lngSyouyoHensaiAll      As Long    '賞与返済額(総額)
 Dim strSyouyoDate1          As String  '賞与支払日１
 Dim strSyouyoDate2          As String  '賞与支払日２
 Dim lngKyuuyoHensai         As Long    '毎月給与返済額
 Dim lngSyouyoHensai         As Long    '毎月賞与返済額
     
'--ワーク---------------------
 Dim i                       As Integer
 Dim intKyuuyoCNT            As Integer '給与が第何回目かの数字
 Dim intSyouyoCNT            As Integer '賞与が第何回目かの数字
 Dim intNenKBN               As Integer '年区分
 Dim intKBN                  As Integer '区分
 Dim strHensaiKijitu         As String  '返済期日
 Dim strSyouyoKijitu         As String  '賞与期日
 Dim lngKyuuyoHensaiZandaka  As Long    '給与返済残高
 Dim lngSyouyoHensaiZandaka  As Long    '賞与返済残高
 Dim intSyouyoHensaiKaisuu   As Integer '賞与返済回数
 Dim strSyouyoSiharaiTuki    As String  '賞与支払月
 Dim strZenkaiHensaiKijitu   As String  '前回返済期日
 Dim intHensaiKikan          As Integer '返済期間
 Dim strZenkaiSyouyoHensaiBi As String  '前回賞与返済日
 Dim dblRisoku1              As Double  '利息
 Dim dblRisoku2              As Double  '利息２
 Dim dblKeiyakuriritu        As Double  '契約利率
    
 Dim Y As Integer

 Dim intNenKBN_WK            As Integer

 Dim StrWork_20011110_1 As String
 Dim StrWork_20011110_2 As String

 'ソート時に使用
 Dim lngSortKey()       As Long

On Error GoTo asd

    '変数にセット
    strYuusibi = Format$(Mid(gstrYusiYMD, 1, 4) & "/" & Mid$(gstrYusiYMD, 5, 2) & "/" & Mid$(gstrYusiYMD, 7, 2), "YYYY/MM/DD") '融資日
    dblRiritu = CDbl(gstrRiritu) * 0.01            '契約利率
    intHensaiTuki = CInt(gstrHensaiTukisu)               '返済月数
    lngKyuuyoHensaiAll = CLng(gstrKyuyoHensaiAll)          '給与返済額(総額)
    lngSyouyoHensaiAll = CLng(gstrSyoyoHensaiAll)         '賞与返済額(総額)
''''    gstrBonusMD1 = Format$(Left$(gstrBonusMD1, 2) & Right$(gstrBonusMD1, 2), "MMDD")                  '賞与支払月日１
''''    gstrBonusMD2 = Format$(Left$(gstrBonusMD2, 2) & Right$(gstrBonusMD2, 2), "MMDD")                  '賞与支払月日2
    lngKyuuyoHensai = CLng(gstrKyuyoHensaigaku)             '毎月給与返済額
    lngSyouyoHensai = CLng(gstrSyoyoHensaigaku)            '毎月賞与返済額
    
    '◇融資日が 2000/11/09 2000/11/10 の場合は 直近のボーナス日を６月１５にする(直金の１２月１日のボーナス日を無視する )
    If strYuusibi = "2000/11/09" Or strYuusibi = "2000/11/10" Then
        'gstrBonusMD1,gstrBonusMD1を逆転させる
        strSyouyoDate1 = "2001/06/15"
        strSyouyoDate2 = "2001/12/01"
    Else
''''''        '賞与支払日判定
''''''''        If Format(Date, "MMDD") < gstrBonusMD1 Then
''''''        If Format(Date, "MMDD") <= gstrBonusMD1 Then
''''''            '賞与支払月日２を賞与支払月日１に
''''''''            strSyouyoDate1 = Format$(Date, "YYYY") & "/" & gstrBonusMD2
''''''''            strSyouyoDate2 = Format$(DateAdd("YYYY", -1, Date), "YYYY") & "/" & gstrBonusMD1
''''''            strSyouyoDate1 = Format$(Date, "YYYY") & "/" & Left$(gstrBonusMD2, 2) & "/" & Right$(gstrBonusMD2, 2)
''''''            strSyouyoDate2 = Format$(DateAdd("YYYY", -1, Date), "YYYY") & "/" & Left$(gstrBonusMD1, 2) & "/" & Right$(gstrBonusMD1, 2)
''''''''        ElseIf Format(Date, "MMDD") > gstrBonusMD2 Then
''''''        ElseIf Format(Date, "MMDD") >= gstrBonusMD2 Then
''''''            '賞与支払月日２を賞与支払月日１に
''''''''            strSyouyoDate1 = Format$(Date, "YYYY") & "/" & gstrBonusMD2
''''''''            strSyouyoDate2 = Format$(DateAdd("YYYY", -1, Date), "YYYY") & "/" & gstrBonusMD1
''''''            strSyouyoDate1 = Format$(Date, "YYYY") & "/" & Left$(gstrBonusMD2, 2) & "/" & Right$(gstrBonusMD2, 2)
''''''            strSyouyoDate2 = Format$(DateAdd("YYYY", -1, Date), "YYYY") & "/" & Left$(gstrBonusMD1, 2) & "/" & Right$(gstrBonusMD1, 2)
''''''        ElseIf Format(Date, "MMDD") > gstrBonusMD1 And Format(Date, "MMDD") < gstrBonusMD2 Then
''''''            strSyouyoDate1 = Format$(Date, "YYYY") & "/" & Left$(gstrBonusMD1, 2) & "/" & Right$(gstrBonusMD1, 2)
''''''            strSyouyoDate2 = Format$(Date, "YYYY") & "/" & Left$(gstrBonusMD2, 2) & "/" & Right$(gstrBonusMD2, 2)
''''''        End If
        If Format(strYuusibi, "MMDD") >= gstrBonusMD1 Then
            If Format(strYuusibi, "MMDD") >= gstrBonusMD2 Then
                strSyouyoDate1 = Format$(DateAdd("yyyy", 1, strYuusibi), "YYYY") & "/" & Left$(gstrBonusMD1, 2) & "/" & Right$(gstrBonusMD1, 2)
                strSyouyoDate2 = Format$(DateAdd("yyyy", 1, strYuusibi), "YYYY") & "/" & Left$(gstrBonusMD2, 2) & "/" & Right$(gstrBonusMD2, 2)
            Else
                If Format(strYuusibi, "MM") = Left(gstrBonusMD2, 2) Then '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''2001/12/12追加
                    strSyouyoDate1 = Format$(DateAdd("yyyy", 1, strYuusibi), "YYYY") & "/" & Left$(gstrBonusMD1, 2) & "/" & Right$(gstrBonusMD1, 2) ''''2001/12/12追加'
                    strSyouyoDate2 = Format$(DateAdd("yyyy", 1, strYuusibi), "YYYY") & "/" & Left$(gstrBonusMD2, 2) & "/" & Right$(gstrBonusMD2, 2) ''''2001/12/12追加
                Else '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''2001/12/12追加
                    strSyouyoDate1 = Format$(DateAdd("yyyy", 0, strYuusibi), "YYYY") & "/" & Left$(gstrBonusMD2, 2) & "/" & Right$(gstrBonusMD2, 2)
                    strSyouyoDate2 = Format$(DateAdd("yyyy", 1, strYuusibi), "YYYY") & "/" & Left$(gstrBonusMD1, 2) & "/" & Right$(gstrBonusMD1, 2)
                End If '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''2001/12/12追加
            End If
        Else
            If Format(strYuusibi, "MM") = Left(gstrBonusMD1, 2) Then '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''2001/12/12追加
                strSyouyoDate1 = Format$(DateAdd("yyyy", 0, strYuusibi), "YYYY") & "/" & Left$(gstrBonusMD2, 2) & "/" & Right$(gstrBonusMD2, 2) ''''2001/12/12追加 '2002/04/22
                strSyouyoDate2 = Format$(DateAdd("yyyy", 1, strYuusibi), "YYYY") & "/" & Left$(gstrBonusMD1, 2) & "/" & Right$(gstrBonusMD1, 2) ''''2001/12/12追加
            Else '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''2001/12/12追加
                strSyouyoDate1 = Format$(DateAdd("yyyy", 0, strYuusibi), "YYYY") & "/" & Left$(gstrBonusMD1, 2) & "/" & Right$(gstrBonusMD1, 2)
                strSyouyoDate2 = Format$(DateAdd("yyyy", 0, strYuusibi), "YYYY") & "/" & Left$(gstrBonusMD2, 2) & "/" & Right$(gstrBonusMD2, 2)
            End If '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''2001/12/12追加
        End If
    End If
    
    ' １回目の賞与返済日までの期間算出のための開始日
    strZenkaiSyouyoHensaiBi = DateAdd("Y", -1, CVDate(strYuusibi))

    '年区分、賞与が第何回目かの数字　の初期化
    intNenKBN = 1
    intKyuuyoCNT = 1
    intSyouyoCNT = 1
    
    ' 賞与の返済回数を求める
    If intHensaiTuki <= 0 Then intHensaiTuki = 1
    intSyouyoHensaiKaisuu = Fix(intHensaiTuki / 6)
    
    '半端な(１５回などの６で割り切れない)月数での返済の場合、半端な月数の中に賞与日があれば、その回数を加算する
    For i = 1 To intHensaiTuki Mod 6
        If DatePart("M", DateAdd("M", i, strYuusibi)) = DatePart("M", strSyouyoDate1) _
        Or DatePart("M", DateAdd("M", i, strYuusibi)) = DatePart("M", strSyouyoDate2) Then
            intSyouyoHensaiKaisuu = intSyouyoHensaiKaisuu + 1
        End If
    Next i
    If intSyouyoHensaiKaisuu <= 0 Then
        intSyouyoHensaiKaisuu = 1
    End If
    
    ' １回目の給与返済日を求める（融資日の翌月の２５日から）
    strHensaiKijitu = DateAdd("M", 1, CVDate(Format$(strYuusibi, "YYYY/MM/25")))
  
    ' １回目の賞与返済日を求める（融資日の翌月以降）
    '◇融資日が 2000/11/09  2000/11/10 の場合は 直近のボーナス日を６月１５にする(直金の１２月１日のボーナス日を無視する )
    If strYuusibi = "2000/11/09" Or strYuusibi = "2000/11/10" Then
        strSyouyoKijitu = "2001/06/15"
    Else
        If DateDiff("Y", strYuusibi, DateAdd("Y", -1, CVDate(Format$(strYuusibi, "YYYY/") & Format$(strSyouyoDate1, "MM") & "/01"))) >= 0 Then       '一ヶ月前
            strSyouyoKijitu = CVDate(Format$(strYuusibi, "YYYY/") & Format$(strSyouyoDate1, "MM/dd"))
        ElseIf DateDiff("Y", strYuusibi, DateAdd("Y", -1, CVDate(Format$(strYuusibi, "YYYY/") & Format$(strSyouyoDate2, "MM") & "/01"))) >= 0 Then   '一ヶ月前
            strSyouyoKijitu = CVDate(Format$(strYuusibi, "YYYY/") & Format$(strSyouyoDate2, "MM/dd"))
        Else
            strSyouyoKijitu = DateAdd("YYYY", 1, CVDate(Format$(strYuusibi, "YYYY/") & Format$(strSyouyoDate1, "MM/dd")))
        End If
    End If

    lngKyuuyoHensaiZandaka = lngKyuuyoHensaiAll
    lngSyouyoHensaiZandaka = lngSyouyoHensaiAll
    
    i = 1
    
    '◆ワークテーブル登録用データ作成
    '* １回目の給与返済用のデータを追加する
    If lngKyuuyoHensaiZandaka > 0 Then
        ReDim Preserve gstrYoteihyouAry(i)
        With gstrYoteihyouAry(i)
            .intPageKbn = Fix((intNenKBN + 2) / 3) ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''ページ区分
            .intNenKBN = intNenKBN  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''年区分
            .strKbn = "給与" & Space$(3 - Len(Format$(1, "###"))) & Format$(1, "###") '''''''''''''''''''''''''''区分
            .strKijitu = gvarCnvDate(1, strHensaiKijitu) ''''''''''''''''''''''''''''''''''''''''''''''''''''''''返済期日
            .strHensai = CStr(lngKyuuyoHensai) ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''返済金額
            ' １回目の利息計算用期間（融資日から１回目までの期間）
            intHensaiKikan = DateDiff("Y", CVDate(DateAdd("Y", -1, CVDate(strYuusibi))), CVDate(strHensaiKijitu))
            '/*利息算出 融資日が新システム移行後(2001/11/01) */                                                    -- 10/23 UPD
            If CDate(Format(strYuusibi, "YYYY/MM/DD")) >= CDate(Format(gcnsstrSysChng, "YYYY/MM/DD")) Then
                dblKeiyakuriritu = Fix(dblRiritu / 365 * 1000000) / 1000000
                .strKyuRsk = Fix(lngKyuuyoHensaiAll * dblKeiyakuriritu * CVar(intHensaiKikan))  ''''''''''''''''''''給与利息''''2002/02/19 upd CVar(intHensaiKikan)
            Else
                dblKeiyakuriritu = dblRiritu * 100
                .strKyuRsk = Fix(lngKyuuyoHensaiAll * dblKeiyakuriritu * CVar(intHensaiKikan) / 36500) ''''''''''''''''''''給与利息''''2002/02/19 upd CVar(intHensaiKikan)
            End If
            .strKyuGan = .strHensai - .strKyuRsk ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''給与元本
            If intHensaiTuki = 1 Then
                .strKyuGan = lngKyuuyoHensaiZandaka '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''給与元本
                .strHensai = lngKyuuyoHensaiZandaka + .strKyuRsk ''''''''''''''''''''''''''''''''''''''''''''''''返済金額
            End If
            lngKyuuyoHensaiZandaka = lngKyuuyoHensaiZandaka - .strKyuGan
            .strKyuZan = lngKyuuyoHensaiZandaka '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''給与返済残高
            .strZandaka = " " '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''残高
            .strSyoGan = " "   ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''賞与元本
            .strSyoRsk = " "   ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''賞与利息
            .strSyoZan = " "   ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''賞与残高
            intKyuuyoCNT = intKyuuyoCNT + 1
            i = i + 1
        End With
    End If
    
    If strYuusibi <> "2000/11/10" Then    '◇融資日が 2000/11/10 の場合は 直近のボーナス日を６月１５にする(直金の１２月１日のボーナス日を無視する )
        If strYuusibi <> "2000/11/09" Then    '◇融資日が 2000/11/10 の場合は 直近のボーナス日を６月１５にする(直金の１２月１日のボーナス日を無視する )
            '* １回目の給与返済月と賞与返済月が一致する場合、１回目の賞与返済用のデータを追加する
            If (DatePart("M", strHensaiKijitu) = DatePart("M", strSyouyoDate1) Or DatePart("M", strHensaiKijitu) = DatePart("M", strSyouyoDate2)) And lngSyouyoHensaiZandaka > 0 Then
                ReDim Preserve gstrYoteihyouAry(i)
                With gstrYoteihyouAry(i)
                
                    If lngKyuuyoHensai > 0 Then
                      .intPageKbn = Fix((intNenKBN + 2) / 3)
                    Else
                      .intPageKbn = 1 ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''ページ区分
                    End If
                    .intNenKBN = intNenKBN ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''年区分
                    .strKbn = "賞与" & String$(3 - Len(Format$(intSyouyoCNT, "###")), "*") & Format$(intSyouyoCNT, "###") ''区分
                    .strKijitu = gvarCnvDate(1, strSyouyoKijitu) ''''''''''''''''''''''''''''''''''''''''''''''''''''''''返済期日
                    .strHensai = CStr(lngSyouyoHensai) ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''返済金額
                    ' １回目の利息計算用期間（融資日から１回目までの期間）
                    intHensaiKikan = DateDiff("Y", CVDate(strZenkaiSyouyoHensaiBi), CVDate(strSyouyoKijitu))
                    '/*利息算出 融資日が新システム移行後(2001/11/01) */                                                    -- 10/23 UPD
                    If CDate(Format(strYuusibi, "YYYY/MM/DD")) >= CDate(Format(gcnsstrSysChng, "YYYY/MM/DD")) Then
                        dblKeiyakuriritu = Fix(dblRiritu / 365 * 1000000) / 1000000
                        .strSyoRsk = Fix(lngSyouyoHensaiAll * dblKeiyakuriritu * CVar(intHensaiKikan))  ''''''''''''''''''''賞与利息''''2002/02/19 upd CVar(intHensaiKikan)
                    Else
                        dblRisoku2 = lngSyouyoHensaiAll * dblRiritu * CVar(intHensaiKikan) / 365 ''''2002/02/19 upd CVar(intHensaiKikan)
                        .strSyoRsk = Int(dblRisoku2) ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''賞与利息
                    End If
                    .strSyoGan = .strHensai - .strSyoRsk ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''賞与元本
                    If intSyouyoHensaiKaisuu = 1 Then
                        .strSyoGan = lngSyouyoHensaiZandaka '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''賞与元本
                        .strHensai = lngSyouyoHensaiZandaka + .strSyoRsk ''''''''''''''''''''''''''''''''''''''''''''''''返済金額
                    End If
                    lngSyouyoHensaiZandaka = lngSyouyoHensaiZandaka - .strSyoGan '賞与返済残高 計算
                    .strSyoZan = lngSyouyoHensaiZandaka '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''賞与残高
                    .strZandaka = " " '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''残高
                    .strKyuGan = " " ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''給与元本
                    .strKyuRsk = " " ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''給与利息
                    .strKyuZan = " " ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''給与返済残高
                    strZenkaiSyouyoHensaiBi = strSyouyoKijitu
                    intSyouyoCNT = intSyouyoCNT + 1
                    i = i + 1
                End With
            End If
        End If
    End If

    strZenkaiHensaiKijitu = strHensaiKijitu
    strHensaiKijitu = DateAdd("M", 1, strHensaiKijitu)
  
    ' ◆◆２回目以降のデータ追加
    intNenKBN_WK = 2
    'While (I <= intHensaiTuki Or intSyouyoCNT <= intSyouyoHensaiKaisuu) And (lngKyuuyoHensaiZandaka > 0 Or lngSyouyoHensaiZandaka > 0)
    While (intKyuuyoCNT <= intHensaiTuki Or intSyouyoCNT <= intSyouyoHensaiKaisuu) And (lngKyuuyoHensaiZandaka > 0 Or lngSyouyoHensaiZandaka > 0)
        '* 給与のデータ追加
        If lngKyuuyoHensaiZandaka > 0 Then
            ReDim Preserve gstrYoteihyouAry(i)
            With gstrYoteihyouAry(i)
                .intPageKbn = Fix((intNenKBN + 2) / 3) ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''ページ区分
                .intNenKBN = intNenKBN ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''年区分
                .strKbn = "給与" & Space$(3 - Len(Format$(intKyuuyoCNT, "###"))) & Format$(intKyuuyoCNT, "###") '区分
                .strKijitu = gvarCnvDate(1, strHensaiKijitu) ''''''''''''''''''''''''''''''''''''''''''''''''''''返済期日
                .strHensai = lngKyuuyoHensai ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''返済金額
                ' 前回から今回の利息計算用期間
                intHensaiKikan = DateDiff("Y", CVDate(strZenkaiHensaiKijitu), CVDate(strHensaiKijitu))
                '/*利息算出 融資日が新システム移行後(2001/11/01) */                                                    -- 10/23 UPD
                If CDate(Format(strYuusibi, "YYYY/MM/DD")) >= CDate(Format(gcnsstrSysChng, "YYYY/MM/DD")) Then
                    dblKeiyakuriritu = Fix(dblRiritu / 365 * 1000000) / 1000000
                    .strKyuRsk = Fix(lngKyuuyoHensaiZandaka * dblKeiyakuriritu * CVar(intHensaiKikan))  ''''''''''''''''''''給与利息  2002/_02_19 Upd CVar(intHensaiKikan)
                Else
                    .strKyuRsk = Fix(lngKyuuyoHensaiZandaka * dblRiritu * CVar(intHensaiKikan) / 365) '''''''''''''''''''''給与利息  2002/_02_19 Upd CVar(intHensaiKikan)
                End If
                .strKyuGan = .strHensai - .strKyuRsk ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''給与元本
                ' 最終回の場合
                If intHensaiTuki = intKyuuyoCNT Then
                    .strKyuGan = lngKyuuyoHensaiZandaka '''''''''''''''''''''''''''''''''''''''''''''''''''''''''給与元本
                    .strHensai = lngKyuuyoHensaiZandaka + .strKyuRsk ''''''''''''''''''''''''''''''''''''''''''''返済金額
                End If
                lngKyuuyoHensaiZandaka = lngKyuuyoHensaiZandaka - .strKyuGan '給与返済残高 計算
                .strKyuZan = lngKyuuyoHensaiZandaka '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''給与残高
                .strZandaka = " "
                .strSyoGan = " " ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''賞与元本
                .strSyoRsk = " " ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''賞与利息
                .strSyoZan = " " ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''賞与残高
                intKyuuyoCNT = intKyuuyoCNT + 1
                i = i + 1
            End With
        End If
        
        '* 当該月と賞与返済月が一致する場合、賞与返済用のデータも追加する
        If (DatePart("M", strHensaiKijitu) = DatePart("M", strSyouyoDate1) Or DatePart("M", strHensaiKijitu) = DatePart("M", strSyouyoDate2)) And lngSyouyoHensaiZandaka > 0 Then
            ReDim Preserve gstrYoteihyouAry(i)
            With gstrYoteihyouAry(i)
                
                If lngKyuuyoHensai > 0 Then
                    .intPageKbn = Fix((intNenKBN + 2) / 3)
                Else
                    .intPageKbn = 1 ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''ページ区分
                End If
                .intNenKBN = intNenKBN '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''年区分
                .strKbn = "賞与" & String$(3 - Len(Format$(intSyouyoCNT, "###")), "*") & Format$(intSyouyoCNT, "###") ''区分
                '* 今回の賞与返済日の算出
                If Month(strHensaiKijitu) = Month(strSyouyoDate1) Then
                    strSyouyoKijitu = CVDate(Format$(strHensaiKijitu, "YYYY/") & Format$(strSyouyoDate1, "MM/dd"))
                Else
                    strSyouyoKijitu = CVDate(Format$(strHensaiKijitu, "YYYY/") & Format$(strSyouyoDate2, "MM/dd"))
                End If
                .strKijitu = gvarCnvDate(1, strSyouyoKijitu) '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''返済期日
                .strHensai = lngSyouyoHensai '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''返済金額
                ' 利息計算用期間
                intHensaiKikan = DateDiff("Y", CVDate(strZenkaiSyouyoHensaiBi), CVDate(strSyouyoKijitu))
                '/*利息算出 融資日が新システム移行後(2001/11/01) */                                                    -- 10/23 UPD
                If CDate(Format(strYuusibi, "YYYY/MM/DD")) >= CDate(Format(gcnsstrSysChng, "YYYY/MM/DD")) Then
                    dblKeiyakuriritu = Fix(dblRiritu / 365 * 1000000) / 1000000
                    .strSyoRsk = Fix(lngSyouyoHensaiZandaka * dblKeiyakuriritu * CVar(intHensaiKikan))  ''''''''''''''''''''賞与利息'''2002/_02_19 Upd CVar(intHensaiKikan)
                Else
                    dblRisoku2 = lngSyouyoHensaiZandaka * dblRiritu * CVar(intHensaiKikan) / 365 '''2002/_02_19 Upd CVar(intHensaiKikan)
                    .strSyoRsk = Int(dblRisoku2) ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''賞与利息
                End If
                .strSyoGan = .strHensai - .strSyoRsk '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''賞与元本
                ' 最終回の場合
                If intSyouyoHensaiKaisuu = intSyouyoCNT Then
                    .strSyoGan = lngSyouyoHensaiZandaka ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''賞与元本
                    .strHensai = lngSyouyoHensaiZandaka + .strSyoRsk '''''''''''''''''''''''''''''''''''''''''''''''''''返済金額
                End If
                lngSyouyoHensaiZandaka = lngSyouyoHensaiZandaka - .strSyoGan '賞与返済残高 計算
                .strSyoZan = lngSyouyoHensaiZandaka
                .strZandaka = " " ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''残高
                .strKyuGan = " " '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''給与元本
                .strKyuRsk = " " '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''給与利息
                .strKyuZan = " " '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''給与返済残高
                strZenkaiSyouyoHensaiBi = strSyouyoKijitu
                intSyouyoCNT = intSyouyoCNT + 1
                i = i + 1
            End With
        End If
        
        strZenkaiHensaiKijitu = strHensaiKijitu
        strHensaiKijitu = DateAdd("M", 1, strHensaiKijitu)
        
        ' １２回（次が賞与の時は、次の賞与まで含まれる）毎に、
        ' 返済予定表に罫線を出力させるための区分のカウントアップ
        If ((intNenKBN_WK) Mod 12) = 0 Then
            intNenKBN = intNenKBN + 1
        End If
        intNenKBN_WK = intNenKBN_WK + 1
        
    Wend

    '■gstrYoteihyouAry配列ソート...賞与データがずれているため■
    For Y = 1 To UBound(gstrYoteihyouAry)
        With gstrYoteihyouAry(Y)
            ReDim Preserve lngSortKey(Y)
            ReDim Preserve gstrYoteihyouSort(Y)
            lngSortKey(Y) = CLng(Format(Mid$(.strKijitu, 1, 2), "00") & Format(Mid$(.strKijitu, 4, 2), "00") & Format(Mid$(.strKijitu, 7, 2), "00"))
            gstrYoteihyouSort(Y).intNenKBN = gstrYoteihyouAry(Y).intNenKBN
            gstrYoteihyouSort(Y).intPageKbn = gstrYoteihyouAry(Y).intPageKbn
            gstrYoteihyouSort(Y).strHensai = gstrYoteihyouAry(Y).strHensai
            gstrYoteihyouSort(Y).strKbn = gstrYoteihyouAry(Y).strKbn
            gstrYoteihyouSort(Y).strKijitu = gstrYoteihyouAry(Y).strKijitu
            gstrYoteihyouSort(Y).strKyuGan = gstrYoteihyouAry(Y).strKyuGan
            gstrYoteihyouSort(Y).strKyuRsk = gstrYoteihyouAry(Y).strKyuRsk
            gstrYoteihyouSort(Y).strKyuZan = gstrYoteihyouAry(Y).strKyuZan
            gstrYoteihyouSort(Y).strSyoGan = gstrYoteihyouAry(Y).strSyoGan
            gstrYoteihyouSort(Y).strSyoRsk = gstrYoteihyouAry(Y).strSyoRsk
            gstrYoteihyouSort(Y).strSyoZan = gstrYoteihyouAry(Y).strSyoZan
            gstrYoteihyouSort(Y).strZandaka = gstrYoteihyouAry(Y).strZandaka
        End With
    Next Y
    
    For Y = 1 To UBound(gstrYoteihyouAry)
        If Y <> 1 Then
            If lngSortKey(Y) < lngSortKey(Y - 1) Then
                gstrYoteihyouAry(Y).intNenKBN = gstrYoteihyouSort(Y - 1).intNenKBN
                gstrYoteihyouAry(Y).intPageKbn = gstrYoteihyouSort(Y - 1).intPageKbn
                gstrYoteihyouAry(Y).strHensai = gstrYoteihyouSort(Y - 1).strHensai
                gstrYoteihyouAry(Y).strKbn = gstrYoteihyouSort(Y - 1).strKbn
                gstrYoteihyouAry(Y).strKijitu = gstrYoteihyouSort(Y - 1).strKijitu
                gstrYoteihyouAry(Y).strKyuGan = gstrYoteihyouSort(Y - 1).strKyuGan
                gstrYoteihyouAry(Y).strKyuRsk = gstrYoteihyouSort(Y - 1).strKyuRsk
                gstrYoteihyouAry(Y).strKyuZan = gstrYoteihyouSort(Y - 1).strKyuZan
                gstrYoteihyouAry(Y).strSyoGan = gstrYoteihyouSort(Y - 1).strSyoGan
                gstrYoteihyouAry(Y).strSyoRsk = gstrYoteihyouSort(Y - 1).strSyoRsk
                gstrYoteihyouAry(Y).strSyoZan = gstrYoteihyouSort(Y - 1).strSyoZan
                gstrYoteihyouAry(Y).strZandaka = gstrYoteihyouSort(Y - 1).strZandaka
            
                gstrYoteihyouAry(Y - 1).intNenKBN = gstrYoteihyouSort(Y).intNenKBN
                gstrYoteihyouAry(Y - 1).intPageKbn = gstrYoteihyouSort(Y).intPageKbn
                gstrYoteihyouAry(Y - 1).strHensai = gstrYoteihyouSort(Y).strHensai
                gstrYoteihyouAry(Y - 1).strKbn = gstrYoteihyouSort(Y).strKbn
                gstrYoteihyouAry(Y - 1).strKijitu = gstrYoteihyouSort(Y).strKijitu
                gstrYoteihyouAry(Y - 1).strKyuGan = gstrYoteihyouSort(Y).strKyuGan
                gstrYoteihyouAry(Y - 1).strKyuRsk = gstrYoteihyouSort(Y).strKyuRsk
                gstrYoteihyouAry(Y - 1).strKyuZan = gstrYoteihyouSort(Y).strKyuZan
                gstrYoteihyouAry(Y - 1).strSyoGan = gstrYoteihyouSort(Y).strSyoGan
                gstrYoteihyouAry(Y - 1).strSyoRsk = gstrYoteihyouSort(Y).strSyoRsk
                gstrYoteihyouAry(Y - 1).strSyoZan = gstrYoteihyouSort(Y).strSyoZan
                gstrYoteihyouAry(Y - 1).strZandaka = gstrYoteihyouSort(Y).strZandaka
            End If
        End If
    Next Y



    '■残高算出■
    lngKyuuyoHensaiZandaka = lngKyuuyoHensaiAll
    lngSyouyoHensaiZandaka = lngSyouyoHensaiAll

    For Y = 1 To UBound(gstrYoteihyouAry)
        With gstrYoteihyouAry(Y)
            If Trim$(.strKyuZan) <> "" Then
                lngKyuuyoHensaiZandaka = .strKyuZan
            End If
            If Trim$(.strSyoZan) <> "" Then
                lngSyouyoHensaiZandaka = .strSyoZan
            End If
            .strZandaka = lngKyuuyoHensaiZandaka + lngSyouyoHensaiZandaka '残高
        End With
    Next Y

asd:
Exit Sub

End Sub
'******************************************************************************
'*    帳票用データ作成
'******************************************************************************
Public Function gfncblnMakPrintDat() As Boolean
 Dim strSQL            As String
 Dim i                 As Long
 Dim j                 As Long
 Const cnsMaxRec       As Long = 100  '一回で出力する最大行数 '''''
 Const cnslngAryCnt    As Long = 100   '配列の件数  及び、１回で取得するＭＡＸの件数
 Dim OraPArray_01      As Object       '01 ページ区分
 Dim OraPArray_02      As Object       '02 年区分
 Dim OraPArray_03      As Object       '03 区分
 Dim OraPArray_04      As Object       '04 返済期日
 Dim OraPArray_05      As Object       '05 返済金額
 Dim OraPArray_06      As Object       '06 残高
 Dim OraPArray_07      As Object       '07 給与元本
 Dim OraPArray_08      As Object       '08 給与利息
 Dim OraPArray_09      As Object       '09 給与残高
 Dim OraPArray_10      As Object       '10 賞与元本
 Dim OraPArray_11      As Object       '11 賞与利息
 Dim OraPArray_12      As Object       '12 賞与残高
 
 Dim StrYuusiYMDWK     As String

On Error GoTo ErrgfncblnMakPrintDat

    gfncblnMakPrintDat = False
    
    'SP用パラメーターセット
    '社員コード１
    odbDatabase.Parameters.Add "InStrSyainCD1", gstrSyainCd1, ORAPARM_INPUT
        odbDatabase.Parameters("InStrSyainCD1").ServerType = ORATYPE_CHAR
    '社員コード２
    odbDatabase.Parameters.Add "InStrSyainCD2", gstrSyainCd2, ORAPARM_INPUT
        odbDatabase.Parameters("InStrSyainCD2").ServerType = ORATYPE_CHAR
    '社員氏名
    odbDatabase.Parameters.Add "InStrSimei", frmQPAV_CEnt080.lblShimeiKanji.Caption, ORAPARM_INPUT
        odbDatabase.Parameters("InStrSimei").ServerType = ORATYPE_VARCHAR2
    '店名称
    odbDatabase.Parameters.Add "InStrMiseNm", frmQPAV_CEnt080.lblMiseName.Caption, ORAPARM_INPUT
        odbDatabase.Parameters("InStrMiseNm").ServerType = ORATYPE_VARCHAR2
    '融資年月日
    If gstrSyori = "登 録" Then
        StrYuusiYMDWK = frmQPAV_CEnt081.txtYuusibiY.Text & "/" & frmQPAV_CEnt081.txtYuusibiM.Text & "/" & frmQPAV_CEnt081.txtYuusibiD.Text
        StrYuusiYMDWK = gvarCnvDate(1, StrYuusiYMDWK)
    Else
        StrYuusiYMDWK = frmQPAV_CEnt081.lblYuusibiY.Caption & "/" & frmQPAV_CEnt081.lblYuusibiM.Caption & "/" & frmQPAV_CEnt081.lblYuusibiD.Caption
        StrYuusiYMDWK = gvarCnvDate(1, StrYuusiYMDWK)
    End If
    odbDatabase.Parameters.Add "InStrYusiYMD", StrYuusiYMDWK, ORAPARM_INPUT
        odbDatabase.Parameters("InStrYusiYMD").ServerType = ORATYPE_VARCHAR2
    '利率
    odbDatabase.Parameters.Add "InStrRiritu", frmQPAV_CEnt081.lblPer.Caption, ORAPARM_INPUT
        odbDatabase.Parameters("InStrRiritu").ServerType = ORATYPE_VARCHAR2
    '融資金額
    odbDatabase.Parameters.Add "InNumYusiKng", CLng(frmQPAV_CEnt081.lblYuusiKei.Caption), ORAPARM_INPUT
        odbDatabase.Parameters("InNumYusiKng").ServerType = ORATYPE_NUMBER
    '給与返済額
    odbDatabase.Parameters.Add "InNumKyuHensai", CLng(frmQPAV_CEnt081.txtYuusiKyuuyo.Text), ORAPARM_INPUT
        odbDatabase.Parameters("InNumKyuHensai").ServerType = ORATYPE_NUMBER
    '賞与返済額
    odbDatabase.Parameters.Add "InNumSyoHensai", CLng(frmQPAV_CEnt081.txtYuusiBonus.Text), ORAPARM_INPUT
        odbDatabase.Parameters("InNumSyoHensai").ServerType = ORATYPE_NUMBER
    '配列件数
    odbDatabase.Parameters.Add "InNumAryCount", UBound(gstrYoteihyouAry), ORAPARM_INPUT
        odbDatabase.Parameters("InNumAryCount").ServerType = ORATYPE_NUMBER
    
    '01 ページ区分配列
              odbDatabase.Parameters.AddTable "InNumPageKBNAry", ORAPARM_INPUT, ORATYPE_NUMBER, cnsMaxRec, 2
    Set OraPArray_01 = odbDatabase.Parameters("InNumPageKBNAry")
    '02 年区分配列
              odbDatabase.Parameters.AddTable "InNumNenKBNAry", ORAPARM_INPUT, ORATYPE_NUMBER, cnsMaxRec, 2
    Set OraPArray_02 = odbDatabase.Parameters("InNumNenKBNAry")
    '03 区分配列
              odbDatabase.Parameters.AddTable "InStrKBNAry", ORAPARM_INPUT, ORATYPE_VARCHAR2, cnsMaxRec, 10
    Set OraPArray_03 = odbDatabase.Parameters("InStrKBNAry")
    '04 返済期日配列
              odbDatabase.Parameters.AddTable "InStrKijituAry", ORAPARM_INPUT, ORATYPE_VARCHAR2, cnsMaxRec, 20
    Set OraPArray_04 = odbDatabase.Parameters("InStrKijituAry")
    '05 返済金額配列
              odbDatabase.Parameters.AddTable "InNumHensaiAry", ORAPARM_INPUT, ORATYPE_NUMBER, cnsMaxRec, 7
    Set OraPArray_05 = odbDatabase.Parameters("InNumHensaiAry")
    '06 残高配列
              odbDatabase.Parameters.AddTable "InNumZandakaAry", ORAPARM_INPUT, ORATYPE_NUMBER, cnsMaxRec, 7
    Set OraPArray_06 = odbDatabase.Parameters("InNumZandakaAry")
    '07 給与元本配列
              odbDatabase.Parameters.AddTable "InNumKyuGanAry", ORAPARM_INPUT, ORATYPE_NUMBER, cnsMaxRec, 7
    Set OraPArray_07 = odbDatabase.Parameters("InNumKyuGanAry")
    '08 給与利息配列
              odbDatabase.Parameters.AddTable "InNumKyuRskAry", ORAPARM_INPUT, ORATYPE_NUMBER, cnsMaxRec, 7
    Set OraPArray_08 = odbDatabase.Parameters("InNumKyuRskAry")
    '09 給与残高配列
              odbDatabase.Parameters.AddTable "InNumKyuZanAry", ORAPARM_INPUT, ORATYPE_NUMBER, cnsMaxRec, 7
    Set OraPArray_09 = odbDatabase.Parameters("InNumKyuZanAry")
    '10 賞与元本配列
              odbDatabase.Parameters.AddTable "InNumSyoGanAry", ORAPARM_INPUT, ORATYPE_NUMBER, cnsMaxRec, 7
    Set OraPArray_10 = odbDatabase.Parameters("InNumSyoGanAry")
    '11 賞与利息配列
              odbDatabase.Parameters.AddTable "InNumSyoRskAry", ORAPARM_INPUT, ORATYPE_NUMBER, cnsMaxRec, 7
    Set OraPArray_11 = odbDatabase.Parameters("InNumSyoRskAry")
    '12 賞与残高配列
              odbDatabase.Parameters.AddTable "InNumSyoZanAry", ORAPARM_INPUT, ORATYPE_NUMBER, cnsMaxRec, 7
    Set OraPArray_12 = odbDatabase.Parameters("InNumSyoZanAry")
    
    'コンピューター名
    odbDatabase.Parameters.Add "InStrCOMPUTERMEI", gstrCommandLine(5), ORAPARM_INPUT
        odbDatabase.Parameters("InStrCOMPUTERMEI").ServerType = ORATYPE_VARCHAR2
    
    'SQL文作成
             strSQL = "BEGIN QPAP_CEnt080PkG.QPAP_CEnt080PrintAdd("
    strSQL = strSQL & " :InStrSyainCD1"           '社員コード１
    strSQL = strSQL & ",:InStrSyainCD2"           '社員コード２
    strSQL = strSQL & ",:InStrSimei"              '社員氏名
    strSQL = strSQL & ",:InStrMiseNm"             '店名勝
    strSQL = strSQL & ",:InStrYusiYMD"            '融資年月日
    strSQL = strSQL & ",:InStrRiritu"             '利率
    strSQL = strSQL & ",:InNumYusiKng"            '融資金額
    strSQL = strSQL & ",:InNumKyuHensai"          '給与返済額
    strSQL = strSQL & ",:InNumSyoHensai"          '賞与返済額
    strSQL = strSQL & ",:InNumAryCount"           '配列件数
    strSQL = strSQL & ",:InNumPageKBNAry"         'ページ区分配列
    strSQL = strSQL & ",:InNumNenKBNAry"          '年区分配列
    strSQL = strSQL & ",:InStrKBNAry"             '区分配列
    strSQL = strSQL & ",:InStrKijituAry"          '返済期日配列
    strSQL = strSQL & ",:InNumHensaiAry"          '返済金額配列
    strSQL = strSQL & ",:InNumZandakaAry"         '残高配列
    strSQL = strSQL & ",:InNumKyuGanAry"          '給与元本配列
    strSQL = strSQL & ",:InNumKyuRskAry"          '給与利息配列
    strSQL = strSQL & ",:InNumKyuZanAry"          '給与残高配列
    strSQL = strSQL & ",:InNumSyoGanAry"          '賞与元本配列
    strSQL = strSQL & ",:InNumSyoRskAry"          '賞与利息配列
    strSQL = strSQL & ",:InNumSyoZanAry"          '賞与残高配列
    strSQL = strSQL & ",:InStrCOMPUTERMEI); END;" 'コンピュータ名
 
    i = 1
    
    Do Until i > UBound(gstrYoteihyouAry)
        For j = 1 To cnsMaxRec '
            If i > UBound(gstrYoteihyouAry) Then
                Exit For
            End If
            With gstrYoteihyouAry(i)
                OraPArray_01.Put_value CLng(.intPageKbn), (j - 1) '01 ページ区分
                OraPArray_02.Put_value CLng(.intNenKBN), (j - 1)  '02 年区分
                OraPArray_03.Put_value .strKbn, (j - 1)           '03 区分
                
                
                If Trim$(frmQPAV_CEnt081.txtYuusibiY.Text) & Trim$(frmQPAV_CEnt081.txtYuusibiM.Text) & Trim$(frmQPAV_CEnt081.txtYuusibiD.Text) < "20000301" Then
                    If Mid$(.strKijitu, 1, 2) > "11" Then
                        If Mid$(.strKijitu, 4, 5) = " 4.30" Then
                            OraPArray_04.Put_value Mid$(.strKijitu, 1, 2) & ". 6.15", (j - 1)                                            '04 返済期日
                        ElseIf Mid$(.strKijitu, 4, 5) = "10.31" Then
                            OraPArray_04.Put_value Mid$(.strKijitu, 1, 2) & ".12. 1", (j - 1)       '04 返済期日
                        Else
                            OraPArray_04.Put_value .strKijitu, (j - 1)        '04 返済期日
                        End If
                    Else
                        OraPArray_04.Put_value .strKijitu, (j - 1)        '04 返済期日
                    End If
                Else
                    OraPArray_04.Put_value .strKijitu, (j - 1)        '04 返済期日
                End If
                
                OraPArray_05.Put_value CLng(.strHensai), (j - 1)  '05 返済金額
                
                
                If .strZandaka = " " Then
                    OraPArray_06.Put_value Null, (j - 1)
                Else
                    OraPArray_06.Put_value CLng(.strZandaka), (j - 1) '06 残高
                End If
                
                
                If .strKyuGan = " " Then                          '07 給与元本
                    OraPArray_07.Put_value Null, (j - 1)
                Else
                    OraPArray_07.Put_value CLng(.strKyuGan), (j - 1)
                End If
                If .strKyuRsk = " " Then                          '08 給与利息
                    OraPArray_08.Put_value Null, (j - 1)
                Else
                    OraPArray_08.Put_value CLng(.strKyuRsk), (j - 1)
                End If
                If .strKyuZan = " " Then                          '09 給与残高
                    OraPArray_09.Put_value Null, (j - 1)
                Else
                    OraPArray_09.Put_value CLng(.strKyuZan), (j - 1)
                End If

                If .strSyoGan = " " Then                          '10 賞与元本
                    OraPArray_10.Put_value Null, (j - 1)
                Else
                    OraPArray_10.Put_value CLng(.strSyoGan), (j - 1)
                End If

                If .strSyoRsk = " " Then                          '11 賞与利息
                    OraPArray_11.Put_value Null, (j - 1)
                Else
                    OraPArray_11.Put_value CLng(.strSyoRsk), (j - 1)
                End If

                If .strSyoZan = " " Then                          '12 賞与残高
                    OraPArray_12.Put_value Null, (j - 1)
                Else
                    OraPArray_12.Put_value CLng(.strSyoZan), (j - 1)
                End If
                
            End With
            i = i + 1
        Next j
        
        '配列件数の値セット
        odbDatabase.Parameters("InNumAryCount").Value = j - 1
        
        'SP実行
        odbDatabase.DbexecuteSQL (strSQL)
    
    Loop
 
    'オブジェクトの開放
    Call gsubParaRemove(odbDatabase)

    gfncblnMakPrintDat = True

    Exit Function

ErrgfncblnMakPrintDat:
'ｴﾗｰ処理
    
    'ｴﾗｰﾒｯｾｰｼﾞ表示
    Call gsubDBErrorMessage(gstrCommandLine(8), cpubMyPrjName, _
                           gstrCommandLine(3), gstrCommandLine(5), gstrGetErrDateFormat)
    'ｵﾌﾞｼﾞｪｸﾄの開放
    Call gsubParaRemove(odbDatabase)

End Function
'******************************************************************************
'* 　 帳票用データ削除
'******************************************************************************
Public Function gfncblnDelPrintDat() As Boolean
 Dim strSQL            As String

On Error GoTo ErrgfncblnDelPrintDat

    gfncblnDelPrintDat = False

    'コンピューター名
    odbDatabase.Parameters.Add "InStrCOMPUTERMEI", gstrCommandLine(5), ORAPARM_INPUT
        odbDatabase.Parameters("InStrCOMPUTERMEI").ServerType = ORATYPE_VARCHAR2

    'SQL文作成
             strSQL = "BEGIN QPAP_CEnt080PkG.QPAP_CEnt080PrintDel("
    strSQL = strSQL & ":InStrCOMPUTERMEI); END;" 'コンピュータ名

    'SP実行
    odbDatabase.DbexecuteSQL (strSQL)

    'オブジェクトの開放
    Call gsubParaRemove(odbDatabase)

    gfncblnDelPrintDat = True

    Exit Function

ErrgfncblnDelPrintDat:
'ｴﾗｰ処理
    
    'ｴﾗｰﾒｯｾｰｼﾞ表示
    Call gsubDBErrorMessage(gstrCommandLine(8), cpubMyPrjName, _
                           gstrCommandLine(3), gstrCommandLine(5), gstrGetErrDateFormat)
    'ｵﾌﾞｼﾞｪｸﾄの開放
    Call gsubParaRemove(odbDatabase)

End Function
'******************************************************************************
'*     毎回賞与返済額算出期間6カ月以外
'******************************************************************************
Function gfnclngSyouyoHensai(dblYuusibi As Double, dblRiritu As Double, varSyouyoDate1 As Variant, varSyouyoDate2 As Variant, intSyouyoHensaiKaisuu As Integer, lngSyouyoHensaiAll As Long, dblRisoku1 As Double, lngSyouyoTeigaku As Long) As Long
 Dim T As Integer
 Dim lngTeiGakuHensai_1 As Long   '定額返済額_WORK
 Dim lngTeiGakuHensai_2 As Long   '定額返済額_WORK2
 Dim lngTeiGakuHensai_3 As Long   '定額返済額_保存
 Dim lngHensaiSagaku    As Long   '返済差額_WORK
 Dim lngHensaiSyuukei   As Long   '返済集計_WORK
 Dim lngSyouyoHenZan    As Long   '賞与返済残高_WORK
 Dim lngSyouyoHenRsk    As Long   '賞与返済利息_WORK
 Dim strSyouyoKijitu    As String '賞与期日_WORK
 Dim strZenkaiSyouyoHen As String '前回賞与返済日_WORK
 Dim lngSaisyuHensai    As Long   '最終返済額_WORK

 Dim dblKeiyakuriritu    As Double   '傾斜ク利率ワーク（新システム2001/11/01以降に使用）

    If lngSyouyoHensaiAll <= 0 Then
        gfnclngSyouyoHensai = 0
        Exit Function
    End If

    '--------------------
    lngTeiGakuHensai_3 = lngSyouyoTeigaku
    lngTeiGakuHensai_1 = lngSyouyoTeigaku

    lngSyouyoHenZan = lngSyouyoHensaiAll - lngTeiGakuHensai_1 + dblRisoku1
    
    lngHensaiSyuukei = lngTeiGakuHensai_1
    lngSaisyuHensai = lngTeiGakuHensai_1
    strZenkaiSyouyoHen = CStr(CDate(Format(dblYuusibi, "YYYY/MM/DD")))

    If DateDiff("Y", dblYuusibi, DateAdd("Y", -1, CVDate(Format$(dblYuusibi, "YYYY/") & Format$(varSyouyoDate1, "MM") & "/01"))) >= 0 Then     '一ヶ月前
        strSyouyoKijitu = CVDate(Format$(dblYuusibi, "YYYY/") & Format$(varSyouyoDate1, "MM/dd"))
    ElseIf DateDiff("Y", dblYuusibi, DateAdd("Y", -1, CVDate(Format$(dblYuusibi, "YYYY/") & Format$(varSyouyoDate2, "MM") & "/01"))) >= 0 Then '一ヶ月前
        strSyouyoKijitu = CVDate(Format$(dblYuusibi, "YYYY/") & Format$(varSyouyoDate2, "MM/dd"))
    Else
        strSyouyoKijitu = DateAdd("YYYY", 1, CVDate(Format$(dblYuusibi, "YYYY/") & Format$(varSyouyoDate1, "MM/dd")))
    End If

    For T = 2 To intSyouyoHensaiKaisuu
        strZenkaiSyouyoHen = strSyouyoKijitu
        If Month(strSyouyoKijitu) = Month(varSyouyoDate1) Then
            strSyouyoKijitu = CVDate(Format$(strSyouyoKijitu, "YYYY/") & Format$(varSyouyoDate2, "MM/dd"))
        Else
            strSyouyoKijitu = CVDate(Format$(DateAdd("YYYY", 1, strSyouyoKijitu), "YYYY/") & Format$(varSyouyoDate1, "MM/dd"))
        End If
        
        '/*利息算出 融資日が新システム移行後(2001/11/01) */                                                    -- 10/23 UPD
        If CDate(Format(dblYuusibi, "YYYY/MM/DD")) >= CDate(Format(gcnsstrSysChng, "YYYY/MM/DD")) Then
            dblKeiyakuriritu = Fix(dblRiritu / 12 * 1000000) / 1000000
            lngSyouyoHenRsk = Fix(lngSyouyoHenZan * dblKeiyakuriritu * DateDiff("m", strZenkaiSyouyoHen, strSyouyoKijitu))
        Else
            lngSyouyoHenRsk = Int(lngSyouyoHenZan * dblRiritu * DateDiff("m", strZenkaiSyouyoHen, strSyouyoKijitu) / 12)
        End If
        
        If T = intSyouyoHensaiKaisuu Then
            lngHensaiSyuukei = lngHensaiSyuukei + lngSyouyoHenZan + lngSyouyoHenRsk
            lngSaisyuHensai = lngSyouyoHenZan + lngSyouyoHenRsk
            lngSyouyoHenZan = 0
        Else
            lngHensaiSyuukei = lngHensaiSyuukei + lngTeiGakuHensai_1
            lngSyouyoHenZan = lngSyouyoHenZan - lngTeiGakuHensai_1 + lngSyouyoHenRsk
        End If
    Next T
    lngTeiGakuHensai_2 = Int(lngHensaiSyuukei / intSyouyoHensaiKaisuu)

    '--------------------
    Do
        lngHensaiSagaku = Abs(lngTeiGakuHensai_1 - lngSaisyuHensai)
        lngTeiGakuHensai_3 = lngTeiGakuHensai_1
        lngTeiGakuHensai_1 = lngTeiGakuHensai_2
        lngSyouyoHenZan = lngSyouyoHensaiAll - lngTeiGakuHensai_1 + dblRisoku1
        lngHensaiSyuukei = lngTeiGakuHensai_1
        lngSaisyuHensai = lngTeiGakuHensai_1
        strZenkaiSyouyoHen = dblYuusibi
        If DateDiff("Y", dblYuusibi, DateAdd("Y", -1, CVDate(Format$(dblYuusibi, "YYYY/") & Format$(varSyouyoDate1, "MM") & "/01"))) >= 0 Then                 '一ヶ月前
            strSyouyoKijitu = CVDate(Format$(dblYuusibi, "YYYY/") & Format$(varSyouyoDate1, "MM/dd"))
        ElseIf DateDiff("Y", dblYuusibi, DateAdd("Y", -1, CVDate(Format$(dblYuusibi, "YYYY/") & Format$(varSyouyoDate2, "MM") & "/01"))) >= 0 Then                 '一ヶ月前
            strSyouyoKijitu = CVDate(Format$(dblYuusibi, "YYYY/") & Format$(varSyouyoDate2, "MM/dd"))
        Else
            strSyouyoKijitu = DateAdd("YYYY", 1, CVDate(Format$(dblYuusibi, "YYYY/") & Format$(varSyouyoDate1, "MM/dd")))
        End If
        For T = 2 To intSyouyoHensaiKaisuu
            strZenkaiSyouyoHen = strSyouyoKijitu
            If Month(strSyouyoKijitu) = Month(varSyouyoDate1) Then
                strSyouyoKijitu = CVDate(Format$(strSyouyoKijitu, "YYYY/") & Format$(varSyouyoDate2, "MM/dd"))
            Else
                strSyouyoKijitu = CVDate(Format$(DateAdd("YYYY", 1, strSyouyoKijitu), "YYYY/") & Format$(varSyouyoDate1, "MM/dd"))
            End If
        
            '/*利息算出 融資日が新システム移行後(2001/11/01) */                                                    -- 10/23 UPD
            If CDate(Format(dblYuusibi, "YYYY/MM/DD")) >= CDate(Format(gcnsstrSysChng, "YYYY/MM/DD")) Then
                dblKeiyakuriritu = Fix(dblRiritu / 12 * 1000000) / 1000000
                lngSyouyoHenRsk = Fix(lngSyouyoHenZan * dblKeiyakuriritu * DateDiff("m", strZenkaiSyouyoHen, strSyouyoKijitu))
            Else
                lngSyouyoHenRsk = Int(lngSyouyoHenZan * dblRiritu * DateDiff("m", strZenkaiSyouyoHen, strSyouyoKijitu) / 12)
            End If
        
            If T = intSyouyoHensaiKaisuu Then
                lngHensaiSyuukei = lngHensaiSyuukei + lngSyouyoHenZan + lngSyouyoHenRsk
                lngSaisyuHensai = lngSyouyoHenZan + lngSyouyoHenRsk
                lngSyouyoHenZan = 0
            Else
                lngHensaiSyuukei = lngHensaiSyuukei + lngTeiGakuHensai_1
                lngSyouyoHenZan = lngSyouyoHenZan - lngTeiGakuHensai_1 + lngSyouyoHenRsk
            End If
        Next T
        lngTeiGakuHensai_2 = Int((lngHensaiSyuukei + 1) / intSyouyoHensaiKaisuu)
    Loop While lngHensaiSagaku > Abs(lngTeiGakuHensai_1 - lngSaisyuHensai)

    '***定額返済額_保存(＋１) の場合で差額を求める
    lngTeiGakuHensai_2 = lngTeiGakuHensai_3
    lngTeiGakuHensai_1 = lngTeiGakuHensai_2 + 1
    lngSyouyoHenZan = lngSyouyoHensaiAll - lngTeiGakuHensai_1 + dblRisoku1
    lngHensaiSyuukei = lngTeiGakuHensai_1
    lngSaisyuHensai = lngTeiGakuHensai_1
    strZenkaiSyouyoHen = dblYuusibi

    If DateDiff("Y", dblYuusibi, DateAdd("Y", -1, CVDate(Format$(dblYuusibi, "YYYY/") & Format$(varSyouyoDate1, "MM") & "/01"))) >= 0 Then                 '一ヶ月前
        strSyouyoKijitu = CVDate(Format$(dblYuusibi, "YYYY/") & Format$(varSyouyoDate1, "MM/dd"))
    ElseIf DateDiff("Y", dblYuusibi, DateAdd("Y", -1, CVDate(Format$(dblYuusibi, "YYYY/") & Format$(varSyouyoDate2, "MM") & "/01"))) >= 0 Then                 '一ヶ月前
        strSyouyoKijitu = CVDate(Format$(dblYuusibi, "YYYY/") & Format$(varSyouyoDate2, "MM/dd"))
    Else
        strSyouyoKijitu = DateAdd("YYYY", 1, CVDate(Format$(dblYuusibi, "YYYY/") & Format$(varSyouyoDate1, "MM/dd")))
    End If
  
    For T = 2 To intSyouyoHensaiKaisuu
        strZenkaiSyouyoHen = strSyouyoKijitu
        If Month(strSyouyoKijitu) = Month(varSyouyoDate1) Then
            strSyouyoKijitu = CVDate(Format$(strSyouyoKijitu, "YYYY/") & Format$(varSyouyoDate2, "MM/dd"))
        Else
            strSyouyoKijitu = CVDate(Format$(DateAdd("YYYY", 1, strSyouyoKijitu), "YYYY/") & Format$(varSyouyoDate1, "MM/dd"))
        End If
        
        '/*利息算出 融資日が新システム移行後(2001/11/01) */                                                    -- 10/23 UPD
        If CDate(Format(dblYuusibi, "YYYY/MM/DD")) >= CDate(Format(gcnsstrSysChng, "YYYY/MM/DD")) Then
            dblKeiyakuriritu = Fix(dblRiritu / 12 * 1000000) / 1000000
            lngSyouyoHenRsk = Fix(lngSyouyoHenZan * dblKeiyakuriritu * DateDiff("m", strZenkaiSyouyoHen, strSyouyoKijitu))
        Else
            lngSyouyoHenRsk = Int(lngSyouyoHenZan * dblRiritu * DateDiff("m", strZenkaiSyouyoHen, strSyouyoKijitu) / 12)
        End If
        
        If T = intSyouyoHensaiKaisuu Then
            lngHensaiSyuukei = lngHensaiSyuukei + lngSyouyoHenZan + lngSyouyoHenRsk
            lngSaisyuHensai = lngSyouyoHenZan + lngSyouyoHenRsk
            lngSyouyoHenZan = 0
        Else
            lngHensaiSyuukei = lngHensaiSyuukei + lngTeiGakuHensai_1
            lngSyouyoHenZan = lngSyouyoHenZan - lngTeiGakuHensai_1 + lngSyouyoHenRsk
        End If
    Next T
      
    If lngHensaiSagaku > Abs(lngTeiGakuHensai_1 - lngSaisyuHensai) Then
        lngTeiGakuHensai_3 = lngTeiGakuHensai_2 + 1
    End If

    If lngHensaiSagaku = Abs(lngTeiGakuHensai_1 - lngSaisyuHensai) Then
        lngTeiGakuHensai_3 = lngTeiGakuHensai_2 + 1
    End If
    
    '***定額返済額_保存(−１) の場合で差額を求める
    lngTeiGakuHensai_1 = lngTeiGakuHensai_2 - 1
    lngSyouyoHenZan = lngSyouyoHensaiAll - lngTeiGakuHensai_1 + dblRisoku1
    lngHensaiSyuukei = lngTeiGakuHensai_1
    lngSaisyuHensai = lngTeiGakuHensai_1
    strZenkaiSyouyoHen = dblYuusibi

    If DateDiff("Y", dblYuusibi, DateAdd("Y", -1, CVDate(Format$(dblYuusibi, "YYYY/") & Format$(varSyouyoDate1, "MM") & "/01"))) >= 0 Then     '一ヶ月前
        strSyouyoKijitu = CVDate(Format$(dblYuusibi, "YYYY/") & Format$(varSyouyoDate1, "MM/dd"))
    ElseIf DateDiff("Y", dblYuusibi, DateAdd("Y", -1, CVDate(Format$(dblYuusibi, "YYYY/") & Format$(varSyouyoDate2, "MM") & "/01"))) >= 0 Then '一ヶ月前
        strSyouyoKijitu = CVDate(Format$(dblYuusibi, "YYYY/") & Format$(varSyouyoDate2, "MM/dd"))
    Else
        strSyouyoKijitu = DateAdd("YYYY", 1, CVDate(Format$(dblYuusibi, "YYYY/") & Format$(varSyouyoDate1, "MM/dd")))
    End If
  
    For T = 2 To intSyouyoHensaiKaisuu
        strZenkaiSyouyoHen = strSyouyoKijitu
        If Month(strSyouyoKijitu) = Month(varSyouyoDate1) Then
            strSyouyoKijitu = CVDate(Format$(strSyouyoKijitu, "YYYY/") & Format$(varSyouyoDate2, "MM/dd"))
        Else
            strSyouyoKijitu = CVDate(Format$(DateAdd("YYYY", 1, strSyouyoKijitu), "YYYY/") & Format$(varSyouyoDate1, "MM/dd"))
        End If
        
        '/*利息算出 融資日が新システム移行後(2001/11/01) */                                                    -- 10/23 UPD
        If CDate(Format(dblYuusibi, "YYYY/MM/DD")) >= CDate(Format(gcnsstrSysChng, "YYYY/MM/DD")) Then
            dblKeiyakuriritu = Fix(dblRiritu / 12 * 1000000) / 1000000
            lngSyouyoHenRsk = Fix(lngSyouyoHenZan * dblKeiyakuriritu * DateDiff("m", strZenkaiSyouyoHen, strSyouyoKijitu))
        Else
            lngSyouyoHenRsk = Int(lngSyouyoHenZan * dblRiritu * DateDiff("m", strZenkaiSyouyoHen, strSyouyoKijitu) / 12)
        End If
        
        If T = intSyouyoHensaiKaisuu Then
            lngHensaiSyuukei = lngHensaiSyuukei + lngSyouyoHenZan + lngSyouyoHenRsk
            lngSaisyuHensai = lngSyouyoHenZan + lngSyouyoHenRsk
            lngSyouyoHenZan = 0
        Else
            lngHensaiSyuukei = lngHensaiSyuukei + lngTeiGakuHensai_1
            lngSyouyoHenZan = lngSyouyoHenZan - lngTeiGakuHensai_1 + lngSyouyoHenRsk
        End If
    Next T
      
    If lngHensaiSagaku >= Abs(lngTeiGakuHensai_1 - lngSaisyuHensai) Then
        lngTeiGakuHensai_3 = lngTeiGakuHensai_2 - 1
    End If

    gfnclngSyouyoHensai = lngTeiGakuHensai_3

End Function
'******************************************************************************
'*    日付変換
'******************************************************************************
Public Function gvarCnvDate(intSyoriFlg As Integer, varHenkanDate As Variant) As Variant
 Dim varHenkanMae As Variant

On Error GoTo TO_ERROR_gvarCnvDate

    gvarCnvDate = Null
  
    varHenkanMae = CVDate(varHenkanDate)

    Select Case intSyoriFlg
        Case 1: gvarCnvDate = Space(2 - Len(Format$(varHenkanMae, "E"))) & Format$(varHenkanMae, "E.") & Space(2 - Len(Format$(varHenkanMae, "M"))) & Format$(varHenkanMae, "M.") & Space(2 - Len(Format$(varHenkanMae, "D"))) & Format$(varHenkanMae, "D")
        Case 2: gvarCnvDate = Format$(varHenkanMae, "GE.") & Space(2 - Len(Format$(varHenkanMae, "M"))) & Format$(varHenkanMae, "M.") & Space(2 - Len(Format$(varHenkanMae, "D"))) & Format$(varHenkanMae, "D")
    End Select

EXIT_gvarCnvDate:
    Exit Function

TO_ERROR_gvarCnvDate:
    Resume EXIT_gvarCnvDate

End Function
'************************************************************************************************************
'*  毎回返済額算出
'*    intHensaiFlg     : 月返済額算出_FLG
'*    strYuusiBi       : 融資日
'*    dblRiritu        : 契約利率
'*    intHensaiTukisuu : 返済月数
'*    lngKyuuyo        : 給与返済額
'*    lngSyouyo        : 賞与返済額
'*    varSyouyoDate1   : 賞与支給月1
'*    varSyouyoDate2   : 賞与支給月2
'************************************************************************************************************
Function gfncstrKeisan(intHensaiFlg As Integer, strYuusibi As Double, dblRiritu As Double, intHensaiTukisuu As Integer, lngKyuuyo As Long, lngSyouyo As Long, varSyouyoDate1 As Variant, varSyouyoDate2 As Variant) As Long
 Dim i                   As Integer
 Dim T                   As Integer
 Dim intNenKBN_WK        As Integer  '年区分_WORK
 Dim intKBN_WK           As Integer  '区分_WORK
 Dim strHensaiKijitu_WK  As Double   '返済期日_WORK
 Dim strSyouyoKijitu_WK  As Double   '賞与期日_WORK
 Dim lngKyuuyoTeigaku_WK As Long     '給与定額返済額_WORK
 Dim lngKyuuyo1Zan_WK    As Long     '給与第1残高_WORK
 Dim lngKyuuyoHenZan_WK  As Long     '給与返済残高_WORK
 Dim lngSyouyoTeigaku_WK As Long     '賞与定額返済額_WORK
 Dim lngSyouyo1Zan_WK    As Long     '賞与第1残高_WORK
 Dim lngSyouyoHenZan_WK  As Long     '賞与返済残高_WORK
 Dim curTeigaku0_WK      As Currency '定額_WORK0
 Dim curTeigaku1_WK      As Currency '定額_WORK1
 Dim curTeigaku2_WK      As Currency '定額_WORK2
 Dim intSyouyoKaisuu_WK  As Integer  '賞与返済回数_WORK
 Dim strSyouyoDate_WK    As Variant  '賞与支給月_WORK
 Dim strHensaiKijitu2_WK As Variant  '返済期日_WORK2
 Dim strHensaiKikan_WK   As Double   '返済期間_WORK
 Dim strZenkaiSyouyo_WK  As Variant  '前回賞与返済日_WORK
 Dim intSyouyoKikan_WK   As Integer  '賞与返済期間_WORK
 Dim dblRisoku_WK        As Double    '利息_WORK
 Dim dblRisoku2_WK       As Double   '利息2_WORK
 Dim strZenkaiKyuuyo     As Variant  '前回給与返済日
 Dim strZenkaiSyouyo     As Variant  '前回賞与返済日
 Dim strDaiitiSyouyo     As Variant  '第1回賞与返済日
 Dim curRisoku           As Currency 'WORK_利息
 Dim curZandaka          As Currency 'WORK_残高
 Dim curSaisyuuHensai    As Currency '最終返済額
 Dim curTeigaku          As Currency '定額_SAVE

 Dim dblKeiyakuriritu    As Double    '契約利率 (2001/11/01以降に使用)


    '********************************************
    '* 融資日が 2000/03/01 を境に処理を分ける
    '********************************************
    If CVDate(strYuusibi) < CVDate("2000/03/01") Then
        '****************
        '* 元々の処理
        '****************
        ' 利率を ％ から 小数 に変換
        If dblRiritu >= 1 Then
            dblRiritu = dblRiritu / 100
        End If
        ' 賞与年月日の小さい方を "１" に設定
        If DateDiff("y", varSyouyoDate1, varSyouyoDate2) < 0 Then
            strSyouyoDate_WK = varSyouyoDate1
            varSyouyoDate1 = varSyouyoDate2
            varSyouyoDate2 = strSyouyoDate_WK
        End If
        intSyouyoKikan_WK = DateDiff("m", varSyouyoDate1, varSyouyoDate2)
        strZenkaiSyouyo = strYuusibi
        intNenKBN_WK = 1
        T = 1
        ' 賞与の返済回数を求める
        If intHensaiTukisuu <= 0 Then
            intHensaiTukisuu = 1
        End If
        
        intSyouyoKaisuu_WK = Fix(intHensaiTukisuu / 6)
        For i = 1 To intHensaiTukisuu Mod 6
            If DatePart("m", DateAdd("m", i, strYuusibi)) = DatePart("m", varSyouyoDate1) Or DatePart("m", DateAdd("m", i, strYuusibi)) = DatePart("m", varSyouyoDate2) Then
                intSyouyoKaisuu_WK = intSyouyoKaisuu_WK + 1
            End If
        Next i
        If intSyouyoKaisuu_WK <= 0 Then intSyouyoKaisuu_WK = 1
        strHensaiKijitu_WK = DateAdd("m", 1, CVDate(Format$(strYuusibi, "yyyy/mm/25")))
        If DateDiff("y", strYuusibi, DateAdd("y", -1, CVDate(Format$(strYuusibi, "yyyy/") & Format$(varSyouyoDate1, "mm") & "/01"))) >= 0 Then                 '一ヶ月前
            strSyouyoKijitu_WK = CVDate(Format$(strYuusibi, "yyyy/") & Format$(varSyouyoDate1, "mm/dd"))
        ElseIf DateDiff("y", strYuusibi, DateAdd("y", -1, CVDate(Format$(strYuusibi, "yyyy/") & Format$(varSyouyoDate2, "mm") & "/01"))) >= 0 Then                 '一ヶ月前
            strSyouyoKijitu_WK = CVDate(Format$(strYuusibi, "yyyy/") & Format$(varSyouyoDate2, "mm/dd"))
        Else
            strSyouyoKijitu_WK = DateAdd("yyyy", 1, CVDate(Format$(strYuusibi, "yyyy/") & Format$(varSyouyoDate1, "mm/dd")))
        End If
        lngKyuuyoHenZan_WK = lngKyuuyo
        lngSyouyoHenZan_WK = lngSyouyo

        '----------------------支払額計算---------------------------
        lngKyuuyoTeigaku_WK = 0
        lngSyouyoTeigaku_WK = 0
        If intHensaiFlg = 1 Then
            If Val(Format(strYuusibi, "dd")) >= 11 Then
                strHensaiKikan_WK = 30
            Else
                strHensaiKikan_WK = 45
            End If
            dblRisoku2_WK = (lngKyuuyo * dblRiritu * strHensaiKikan_WK / 12 / 30)
            dblRisoku_WK = Int(dblRisoku2_WK)
            If intHensaiTukisuu <= 1 Then
                lngKyuuyoTeigaku_WK = dblRisoku_WK + lngKyuuyo
            Else
                curTeigaku0_WK = 0
                curTeigaku1_WK = Abs(-Pmt(dblRiritu / 12, intHensaiTukisuu - 1, lngKyuuyo, 0, 0))
                curTeigaku2_WK = Abs(-Pmt(dblRiritu / 12, intHensaiTukisuu - 1, lngKyuuyo - curTeigaku1_WK + dblRisoku2_WK, 0, 0))
                While Abs(curTeigaku1_WK - curTeigaku2_WK) > 0.001 Or Abs(curTeigaku0_WK - curTeigaku2_WK) > 0.001
                    curTeigaku0_WK = curTeigaku1_WK: curTeigaku1_WK = curTeigaku2_WK
                    curTeigaku2_WK = Abs(-Pmt(dblRiritu / 12, intHensaiTukisuu - 1, lngKyuuyo - (((curTeigaku0_WK) + (curTeigaku1_WK)) / 2) + dblRisoku2_WK, 0, 0))
                Wend
                lngKyuuyoTeigaku_WK = Fix(Abs(((curTeigaku0_WK) + (curTeigaku1_WK) + (curTeigaku2_WK)) / 3))
            End If
        End If
        If intHensaiFlg = 2 Then
            If intSyouyoKikan_WK = 6 Then
                If Month(DateAdd("y", 1, strSyouyoKijitu_WK)) <> Month(strSyouyoKijitu_WK) Then
                    dblRisoku2_WK = (lngSyouyo * dblRiritu * (DateDiff("m", strYuusibi, strSyouyoKijitu_WK) * 30 + IIf(Val(Format(strYuusibi, "dd")) >= 11, 6, 21)) / 2 / 180)
                Else
                    dblRisoku2_WK = (lngSyouyo * dblRiritu * (DateDiff("m", strYuusibi, strSyouyoKijitu_WK) * 30 + IIf(Val(Format(strYuusibi, "dd")) >= 11, 6, 21) + (Day(strSyouyoKijitu_WK) - 1 - 30)) / 2 / 180)
                End If
                dblRisoku_WK = Int(dblRisoku2_WK)
            Else
                dblRisoku2_WK = (lngSyouyo * dblRiritu * (DateDiff("m", strYuusibi, strSyouyoKijitu_WK) * 30 + IIf(Val(Format(strYuusibi, "dd")) >= 11, 6, 21) + ((10) - 1 - 30)) / 2 / 180)
                dblRisoku_WK = Int(dblRisoku2_WK)
            End If
            If intSyouyoKaisuu_WK <= 1 Then
                lngSyouyoTeigaku_WK = dblRisoku_WK + lngSyouyo
            Else
                curTeigaku0_WK = 0
                curTeigaku1_WK = Abs(-Pmt(dblRiritu / 2, intSyouyoKaisuu_WK - 1, lngSyouyo, 0, 0))
                curTeigaku2_WK = Abs(-Pmt(dblRiritu / 2, intSyouyoKaisuu_WK - 1, lngSyouyo - curTeigaku1_WK + dblRisoku2_WK, 0, 0))
                While Abs(curTeigaku1_WK - curTeigaku2_WK) > 0.001 Or Abs(curTeigaku0_WK - curTeigaku2_WK) > 0.001
                    curTeigaku0_WK = curTeigaku1_WK: curTeigaku1_WK = curTeigaku2_WK
                    curTeigaku2_WK = Abs(-Pmt(dblRiritu / 2, intSyouyoKaisuu_WK - 1, lngSyouyo - (((curTeigaku0_WK) + (curTeigaku1_WK)) / 2) + dblRisoku2_WK, 0, 0))
                Wend
                lngSyouyoTeigaku_WK = Fix(Abs(((curTeigaku0_WK) + (curTeigaku1_WK) + (curTeigaku2_WK)) / 3))
                If intSyouyoKikan_WK <> 6 Then
                    lngSyouyoTeigaku_WK = gfnclngSyouyoHensai(CDbl(strYuusibi), dblRiritu, varSyouyoDate1, varSyouyoDate2, intSyouyoKaisuu_WK, lngSyouyo, dblRisoku_WK, lngSyouyoTeigaku_WK)
               
                End If
            End If
        End If
        '-------------------------------------------------------------
    Else
        '****************
        '* 新しい処理
        '****************
        ' 利率を ％ から 小数 に変換
        If dblRiritu >= 1 Then
            dblRiritu = dblRiritu / 100
        End If
        ' 賞与年月日の小さい方を "１" に設定
        If DateDiff("y", varSyouyoDate1, varSyouyoDate2) < 0 Then
            strSyouyoDate_WK = varSyouyoDate1
            varSyouyoDate1 = varSyouyoDate2
            varSyouyoDate2 = strSyouyoDate_WK
        End If
        ' 賞与の返済回数を求める
        If intHensaiTukisuu <= 0 Then
            intHensaiTukisuu = 1
        End If
        intSyouyoKaisuu_WK = Fix(intHensaiTukisuu / 6)
        ' 半端な（１５回などの６で割り切れない）月数での返済の場合、
        ' 半端な月数の中に賞与日があれば、その回数を加算する
        ' 但し、フォーム（社員融資台帳）では、６の倍数の回数しか入力できない為、
        ' ありえないが、元々の処理をそのままとした
        For i = 1 To intHensaiTukisuu Mod 6
            If DatePart("m", DateAdd("m", i, strYuusibi)) = DatePart("m", varSyouyoDate1) Or DatePart("m", DateAdd("m", i, strYuusibi)) = DatePart("m", varSyouyoDate2) Then
                intSyouyoKaisuu_WK = intSyouyoKaisuu_WK + 1
            End If
        Next i
        If intSyouyoKaisuu_WK <= 0 Then
            intSyouyoKaisuu_WK = 1
        End If
        ' １回目の給与返済日を求める（融資日の翌月の２５日から）
        strHensaiKijitu_WK = DateAdd("m", 1, CVDate(Format$(strYuusibi, "yyyy/mm/25")))
        ' １回目の賞与返済日を求める（融資日の翌月以降）
        If DateDiff("y", strYuusibi, DateAdd("y", -1, CVDate(Format$(strYuusibi, "yyyy/") & Format$(varSyouyoDate1, "mm") & "/01"))) >= 0 Then                 '一ヶ月前
            strSyouyoKijitu_WK = CVDate(Format$(strYuusibi, "yyyy/") & Format$(varSyouyoDate1, "mm/dd"))
        ElseIf DateDiff("y", strYuusibi, DateAdd("y", -1, CVDate(Format$(strYuusibi, "yyyy/") & Format$(varSyouyoDate2, "mm") & "/01"))) >= 0 Then                 '一ヶ月前
            strSyouyoKijitu_WK = CVDate(Format$(strYuusibi, "yyyy/") & Format$(varSyouyoDate2, "mm/dd"))
        Else
            strSyouyoKijitu_WK = DateAdd("yyyy", 1, CVDate(Format$(strYuusibi, "yyyy/") & Format$(varSyouyoDate1, "mm/dd")))
        End If
        lngKyuuyoHenZan_WK = lngKyuuyo
        lngSyouyoHenZan_WK = lngSyouyo
        
        '----------------------支払額計算---------------------------
        lngKyuuyoTeigaku_WK = 0
        lngSyouyoTeigaku_WK = 0
        '****************************
        '* 給与の毎月の返済額の計算
        '****************************
        If intHensaiFlg = 1 Then
            ' 融資日（計算する時は−１日する）から、１回目の給与返済日までの期間算出
            strHensaiKikan_WK = DateDiff("y", CVDate(DateAdd("y", -1, CVDate(strYuusibi))), CVDate(strHensaiKijitu_WK))
            
            '/*利息算出 融資日が新システム移行後(2001/11/01) */                                                    -- 10/23 UPD
             ' １回目の給与返済日までの利息計算
            If CDate(Format(strYuusibi, "YYYY/MM/DD")) >= CDate(Format(gcnsstrSysChng, "YYYY/MM/DD")) Then
                dblKeiyakuriritu = Fix(dblRiritu / 365 * 1000000) / 1000000
                dblRisoku_WK = Fix(lngKyuuyo * dblKeiyakuriritu * strHensaiKikan_WK)
            Else
                dblRisoku2_WK = (lngKyuuyo * dblRiritu * strHensaiKikan_WK / 365)
                dblRisoku_WK = Int(dblRisoku2_WK)
            End If
            
            
            If intHensaiTukisuu <= 1 Then
                ' １回での返済の場合
                lngKyuuyoTeigaku_WK = curRisoku + lngKyuuyo
            Else
                '* 標準関数で求める毎回の返済金額
                curTeigaku0_WK = Int(Abs(-Pmt(dblRiritu / 12, intHensaiTukisuu, lngKyuuyo, 0, 0)))
                '* １回目用の前回返済日（融資日−１日）
                strZenkaiKyuuyo = CVDate(DateAdd("y", -1, CVDate(strYuusibi)))
                '* １回目用の返済日（融資日の翌月の２５日）
                strHensaiKijitu_WK = DateAdd("m", 1, CVDate(Format$(strYuusibi, "yyyy/mm/25")))
                curZandaka = lngKyuuyo
                '*********************************************************
                '* １回目から返済回数−１回目までの返済予定を順次計算し、
                '* 最終返済での返済額を計算する
                '*********************************************************
                For i = 1 To intHensaiTukisuu - 1
                    strHensaiKikan_WK = DateDiff("y", CVDate(strZenkaiKyuuyo), CVDate(strHensaiKijitu_WK))
                    
                    '/*利息算出 融資日が新システム移行後(2001/11/01) */                                                    -- 10/23 UPD
                    If CDate(Format(strYuusibi, "YYYY/MM/DD")) >= CDate(Format(gcnsstrSysChng, "YYYY/MM/DD")) Then
                        dblKeiyakuriritu = Fix(dblRiritu / 365 * 1000000) / 1000000
                        curRisoku = Fix(curZandaka * dblKeiyakuriritu * strHensaiKikan_WK)
                    Else
                        curRisoku = Int(curZandaka * dblRiritu * strHensaiKikan_WK / 365)
                    End If
                    
                    curZandaka = curZandaka - (curTeigaku0_WK - curRisoku)
                    strZenkaiKyuuyo = strHensaiKijitu_WK
                    strHensaiKijitu_WK = DateAdd("m", 1, strHensaiKijitu_WK)
                Next i
                '* 最終返済での利息計算
                strHensaiKikan_WK = DateDiff("y", CVDate(strZenkaiKyuuyo), CVDate(strHensaiKijitu_WK))
                
                '/*利息算出 融資日が新システム移行後(2001/11/01) */                                                    -- 10/23 UPD
                If CDate(Format(strYuusibi, "YYYY/MM/DD")) >= CDate(Format(gcnsstrSysChng, "YYYY/MM/DD")) Then
                    dblKeiyakuriritu = Fix(dblRiritu / 365 * 1000000) / 1000000
                    curRisoku = Fix(curZandaka * dblKeiyakuriritu * strHensaiKikan_WK)
                Else
                    curRisoku = Int(curZandaka * dblRiritu * strHensaiKikan_WK / 365)
                End If
                
                '* 最終返済での返済額
                curSaisyuuHensai = curRisoku + curZandaka
                '* 標準関数で求めた毎回返済額と、最終返済額の比較
                If curTeigaku0_WK = curSaisyuuHensai Then
                    '* 一致する場合は、標準関数で求めた毎回返済額とする
                    curTeigaku = curTeigaku0_WK
                Else
                    If curTeigaku0_WK < curSaisyuuHensai Then
                        '* 標準関数で求めた毎回返済額より、最終返済額が大きい場合
                        '*********************************************************
                        '* 標準関数で求めた毎回返済額を＋１円ずつしながら、
                        '* 最終返済額を計算し、最も近い金額を算出する
                        '* （但し、毎回返済額 <= 最終返済額 となる金額）
                        '*********************************************************
                        curTeigaku = curTeigaku0_WK
                        Do
                            '* 毎回返済額を１円増額
                            curTeigaku0_WK = curTeigaku0_WK + 1
                            strZenkaiKyuuyo = CVDate(DateAdd("y", -1, CVDate(strYuusibi)))
                            strHensaiKijitu_WK = DateAdd("m", 1, CVDate(Format$(strYuusibi, "yyyy/mm/25")))
                            curZandaka = lngKyuuyo
                            For i = 1 To intHensaiTukisuu - 1
                                strHensaiKikan_WK = DateDiff("y", CVDate(strZenkaiKyuuyo), CVDate(strHensaiKijitu_WK))
                                
                                '/*利息算出 融資日が新システム移行後(2001/11/01) */                                                    -- 10/23 UPD
                                If CDate(Format(strYuusibi, "YYYY/MM/DD")) >= CDate(Format(gcnsstrSysChng, "YYYY/MM/DD")) Then
                                    dblKeiyakuriritu = Fix(dblRiritu / 365 * 1000000) / 1000000
                                    curRisoku = Fix(curZandaka * dblKeiyakuriritu * strHensaiKikan_WK)
                                Else
                                    curRisoku = Int(curZandaka * dblRiritu * strHensaiKikan_WK / 365)
                                End If
                                
                                curZandaka = curZandaka - (curTeigaku0_WK - curRisoku)
                                strZenkaiKyuuyo = strHensaiKijitu_WK
                                strHensaiKijitu_WK = DateAdd("m", 1, strHensaiKijitu_WK)
                            Next i
                            '* 最終返済での利息計算
                            strHensaiKikan_WK = DateDiff("y", CVDate(strZenkaiKyuuyo), CVDate(strHensaiKijitu_WK))
                            
                            '/*利息算出 融資日が新システム移行後(2001/11/01) */                                                    -- 10/23 UPD
                            If CDate(Format(strYuusibi, "YYYY/MM/DD")) >= CDate(Format(gcnsstrSysChng, "YYYY/MM/DD")) Then
                                dblKeiyakuriritu = Fix(dblRiritu / 365 * 1000000) / 1000000
                                curRisoku = Fix(curZandaka * dblKeiyakuriritu * strHensaiKikan_WK)
                            Else
                                curRisoku = Int(curZandaka * dblRiritu * strHensaiKikan_WK / 365)
                            End If
                            
                            '* 最終返済での返済額
                            curSaisyuuHensai = curRisoku + curZandaka
                            
                            '* 今回のループの毎回返済額と、最終返済額の比較
                            If curTeigaku0_WK < curSaisyuuHensai Then
                                    
                                curTeigaku = curTeigaku0_WK
                                                                    
                            Else
                                '* 今回のループの毎回返済額が、最終返済額より大きくなった場合、
                                '* 計算終了 −−＞ １回前の金額を毎回返済額とする
                                Exit Do
                            End If
                        Loop
                    Else
                        '* 最終返済額より、標準関数で求めた毎回返済額が大きい場合
                        '*********************************************************
                        '* 標準関数で求めた毎回返済額を−１円ずつしながら、
                        '* 最終返済額を計算し、最も近い金額を算出する
                        '* （但し、毎回返済額 <= 最終返済額 となる金額）
                        '*********************************************************
                        curTeigaku = curTeigaku0_WK
                        Do
                            '* 毎回返済額を１円減額
                            curTeigaku0_WK = curTeigaku0_WK - 1
                            strZenkaiKyuuyo = CVDate(DateAdd("y", -1, CVDate(strYuusibi)))
                            strHensaiKijitu_WK = DateAdd("m", 1, CVDate(Format$(strYuusibi, "yyyy/mm/25")))
                            curZandaka = lngKyuuyo
                            For i = 1 To intHensaiTukisuu - 1
                                strHensaiKikan_WK = DateDiff("y", CVDate(strZenkaiKyuuyo), CVDate(strHensaiKijitu_WK))
                                
                                '/*利息算出 融資日が新システム移行後(2001/11/01) */                                                    -- 10/23 UPD
                                If CDate(Format(strYuusibi, "YYYY/MM/DD")) >= CDate(Format(gcnsstrSysChng, "YYYY/MM/DD")) Then
                                    dblKeiyakuriritu = Fix(dblRiritu / 365 * 1000000) / 1000000
                                    curRisoku = Fix(curZandaka * dblKeiyakuriritu * strHensaiKikan_WK)
                                Else
                                    curRisoku = Int(curZandaka * dblRiritu * strHensaiKikan_WK / 365)
                                End If
                                
                                curZandaka = curZandaka - (curTeigaku0_WK - curRisoku)
                                strZenkaiKyuuyo = strHensaiKijitu_WK
                                strHensaiKijitu_WK = DateAdd("m", 1, strHensaiKijitu_WK)
                            Next i
                            '* 最終返済での利息計算
                            strHensaiKikan_WK = DateDiff("y", CVDate(strZenkaiKyuuyo), CVDate(strHensaiKijitu_WK))
                                
                            '/*利息算出 融資日が新システム移行後(2001/11/01) */                                                    -- 10/23 UPD
                            If CDate(Format(strYuusibi, "YYYY/MM/DD")) >= CDate(Format(gcnsstrSysChng, "YYYY/MM/DD")) Then
                                dblKeiyakuriritu = Fix(dblRiritu / 365 * 1000000) / 1000000
                                curRisoku = Fix(curZandaka * dblKeiyakuriritu * strHensaiKikan_WK)
                            Else
                                curRisoku = Int(curZandaka * dblRiritu * strHensaiKikan_WK / 365)
                            End If
                            
                            '* 最終返済での返済額
                            curSaisyuuHensai = curRisoku + curZandaka
                            
                            '* 今回のループの毎回返済額と、最終返済額の比較
                            If curTeigaku0_WK <= curSaisyuuHensai Then
                                '* 今回のループの毎回返済額が、最終返済額以下になった場合、
                                '* 計算終了 −−＞ 今回の金額を毎回返済額とする
                                curTeigaku = curTeigaku0_WK
                                Exit Do
                            End If
                        
                        Loop
                    End If
                End If
                lngKyuuyoTeigaku_WK = curTeigaku
            End If
        End If
        '****************************
        '* 賞与の毎回の返済額の計算
        '****************************
        If intHensaiFlg = 2 Then
            ' 融資日（計算する時は−１日する）から、１回目の賞与返済日までの期間算出
            strHensaiKikan_WK = DateDiff("y", CVDate(DateAdd("y", -1, CVDate(strYuusibi))), CVDate(strSyouyoKijitu_WK))
            
            '/*利息算出 融資日が新システム移行後(2001/11/01) */                                                    -- 10/23 UPD
             ' １回目の給与返済日までの利息計算
            If CDate(Format(strYuusibi, "YYYY/MM/DD")) >= CDate(Format(gcnsstrSysChng, "YYYY/MM/DD")) Then
                dblKeiyakuriritu = Fix(dblRiritu / 365 * 1000000) / 1000000
                dblRisoku_WK = Fix(lngSyouyo * dblKeiyakuriritu * strHensaiKikan_WK)
            Else
                dblRisoku2_WK = (lngSyouyo * dblRiritu * strHensaiKikan_WK / 365)
                dblRisoku_WK = Int(dblRisoku2_WK)
            End If
            
            '* １回目の賞与返済日の退避
            strDaiitiSyouyo = strSyouyoKijitu_WK
            If intSyouyoKaisuu_WK <= 1 Then
                ' １回での返済の場合
                lngSyouyoTeigaku_WK = dblRisoku_WK + lngSyouyo
            Else
                '* 標準関数で求める毎回の返済金額（利率は賞与の間隔が均等な年２回と仮定して計算する）
                curTeigaku0_WK = Int(Abs(-Pmt(dblRiritu / 2, intSyouyoKaisuu_WK, lngSyouyo, 0, 0)))
                '* １回目用の前回返済日（融資日−１日）
                strZenkaiSyouyo_WK = CVDate(DateAdd("y", -1, CVDate(strYuusibi)))
                curZandaka = lngSyouyo
                '*********************************************************
                '* １回目から賞与の返済回数−１回目までの返済予定を順次計算し、
                '* 最終返済での返済額を計算する
                '*********************************************************
                For i = 1 To intSyouyoKaisuu_WK - 1
                    strHensaiKikan_WK = DateDiff("y", CVDate(strZenkaiSyouyo_WK), CVDate(strSyouyoKijitu_WK))
                    
                    '/*利息算出 融資日が新システム移行後(2001/11/01) */                                                    -- 10/23 UPD
                    If CDate(Format(strYuusibi, "YYYY/MM/DD")) >= CDate(Format(gcnsstrSysChng, "YYYY/MM/DD")) Then
                        dblKeiyakuriritu = Fix(dblRiritu / 365 * 1000000) / 1000000
                        curRisoku = Fix(curZandaka * dblKeiyakuriritu * strHensaiKikan_WK)
                    Else
                        curRisoku = Int(curZandaka * dblRiritu * strHensaiKikan_WK / 365)
                    End If
                    
                    curZandaka = curZandaka - (curTeigaku0_WK - curRisoku)
                    strZenkaiSyouyo_WK = strSyouyoKijitu_WK
                    '* 次回の賞与日の計算
'*20031030
'次賞与が年度をまたぐ場合「* 最終返済での利息計算」にて、日付がマイナスになる不具合を修正
                    If Year(varSyouyoDate1) <> Year(varSyouyoDate2) Then
                        '年度をまたぐ場合
                        If Month(strSyouyoKijitu_WK) = Month(varSyouyoDate1) Then
                            '次賞与が夏季の時年度に１追加
                            strSyouyoKijitu_WK = CVDate(Format$(Year(strSyouyoKijitu_WK) + 1, "0000") & "/" & Format$(varSyouyoDate2, "mm/dd"))
                        Else
                            '次賞与は冬季の時は年度は変わらず
                            strSyouyoKijitu_WK = CVDate(Format$(strSyouyoKijitu_WK, "yyyy/") & Format$(varSyouyoDate1, "mm/dd"))
                        End If
                    Else
                        '年度をまたがない場合
                        If Month(strSyouyoKijitu_WK) = Month(varSyouyoDate1) Then
                            '次賞与は冬季の時は年度は変わらず
                            strSyouyoKijitu_WK = CVDate(Format$(strSyouyoKijitu_WK, "yyyy/") & Format$(varSyouyoDate2, "mm/dd"))
                        Else
                            '次賞与が夏季の時年度に１追加
                            strSyouyoKijitu_WK = CVDate(Format$(Year(strSyouyoKijitu_WK) + 1, "0000") & "/" & Format$(varSyouyoDate1, "mm/dd"))
                        End If
                    End If
'修正前の処理↓
'                    If Month(strSyouyoKijitu_WK) = Month(varSyouyoDate1) Then
'                        strSyouyoKijitu_WK = CVDate(Format$(strSyouyoKijitu_WK, "yyyy/") & Format$(varSyouyoDate2, "mm/dd"))
'                    Else
'                        strSyouyoKijitu_WK = CVDate(Format$(Year(strSyouyoKijitu_WK) + 1, "0000") & "/" & Format$(varSyouyoDate1, "mm/dd"))
'                    End If
'*20031030
                Next i
                '* 最終返済での利息計算
                strHensaiKikan_WK = DateDiff("y", CVDate(strZenkaiSyouyo_WK), CVDate(strSyouyoKijitu_WK))
                
                '/*利息算出 融資日が新システム移行後(2001/11/01) */                                                    -- 10/23 UPD
                If CDate(Format(strYuusibi, "YYYY/MM/DD")) >= CDate(Format(gcnsstrSysChng, "YYYY/MM/DD")) Then
                    dblKeiyakuriritu = Fix(dblRiritu / 365 * 1000000) / 1000000
                    curRisoku = Fix(curZandaka * dblKeiyakuriritu * strHensaiKikan_WK)
                Else
                    curRisoku = Int(curZandaka * dblRiritu * strHensaiKikan_WK / 365)
                End If
                
                '* 最終返済での返済額
                curSaisyuuHensai = curRisoku + curZandaka
                '* 標準関数で求めた毎回返済額と、最終返済額の比較
                If curTeigaku0_WK = curSaisyuuHensai Then
                    '* 一致する場合は、標準関数で求めた毎回返済額とする
                    curTeigaku = curTeigaku0_WK
                Else
                    If curTeigaku0_WK < curSaisyuuHensai Then
                        '* 標準関数で求めた毎回返済額より、最終返済額が大きい場合
                        '*********************************************************
                        '* 毎回返済額が１０００円以上の場合、ループの回数を減らすため
                        '* 標準関数で求めた毎回返済額を＋１０００円ずつしながら、
                        '* 最終返済額を計算し、最終返済額が算出した毎回返済額よりも
                        '* 大きくなった１個前の金額を求める
                        '* （賞与の場合、誤差が大きいのでこの処理を追加する。
                        '* 　給与の場合は誤差が少ないのでこの処理はない。）
                        '*********************************************************
                        curTeigaku = curTeigaku0_WK
                        If Int(curTeigaku0_WK / 1000) >= 1 Then
                            Do
                                '* 毎回返済額を１円増額
                                curTeigaku0_WK = curTeigaku0_WK + 1000
                                curSaisyuuHensai = CVDate(DateAdd("y", -1, CVDate(strYuusibi)))
                                strSyouyoKijitu_WK = CVDate(strDaiitiSyouyo)
                                curZandaka = lngSyouyo
                                For i = 1 To intSyouyoKaisuu_WK - 1
                                    strHensaiKikan_WK = DateDiff("y", CVDate(strZenkaiSyouyo_WK), CVDate(strSyouyoKijitu_WK))
                                    
                                    '/*利息算出 融資日が新システム移行後(2001/11/01) */                                                    -- 10/23 UPD
                                    If CDate(Format(strYuusibi, "YYYY/MM/DD")) >= CDate(Format(gcnsstrSysChng, "YYYY/MM/DD")) Then
                                        dblKeiyakuriritu = Fix(dblRiritu / 365 * 1000000) / 1000000
                                        curRisoku = Fix(curZandaka * dblKeiyakuriritu * strHensaiKikan_WK)
                                    Else
                                        curRisoku = Int(curZandaka * dblRiritu * strHensaiKikan_WK / 365)
                                    End If
                                    
                                    curZandaka = curZandaka - (curTeigaku0_WK - curRisoku)
                                    strZenkaiSyouyo_WK = strSyouyoKijitu_WK

                                    '* 次回の賞与日の計算
'*20031030
'次賞与が年度をまたぐ場合「* 最終返済での利息計算」にて、日付がマイナスになる不具合を修正
                                    If Year(varSyouyoDate1) <> Year(varSyouyoDate2) Then
                                        '年度をまたぐ場合
                                        If Month(strSyouyoKijitu_WK) = Month(varSyouyoDate1) Then
                                            '次賞与が夏季の時年度に１追加
                                            strSyouyoKijitu_WK = CVDate(Format$(Year(strSyouyoKijitu_WK) + 1, "0000") & "/" & Format$(varSyouyoDate2, "mm/dd"))
                                        Else
                                            '次賞与は冬季の時は年度は変わらず
                                            strSyouyoKijitu_WK = CVDate(Format$(strSyouyoKijitu_WK, "yyyy/") & Format$(varSyouyoDate1, "mm/dd"))
                                        End If
                                    Else
                                        '年度をまたがない場合
                                        If Month(strSyouyoKijitu_WK) = Month(varSyouyoDate1) Then
                                            '次賞与は冬季の時は年度は変わらず
                                            strSyouyoKijitu_WK = CVDate(Format$(strSyouyoKijitu_WK, "yyyy/") & Format$(varSyouyoDate2, "mm/dd"))
                                        Else
                                            '次賞与が夏季の時年度に１追加
                                            strSyouyoKijitu_WK = CVDate(Format$(Year(strSyouyoKijitu_WK) + 1, "0000") & "/" & Format$(varSyouyoDate1, "mm/dd"))
                                        End If
                                    End If
'修正前の処理↓
'                                    If Month(strSyouyoKijitu_WK) = Month(varSyouyoDate1) Then
'                                        strSyouyoKijitu_WK = CVDate(Format$(strSyouyoKijitu_WK, "yyyy/") & Format$(varSyouyoDate2, "mm/dd"))
'                                    Else
'                                        strSyouyoKijitu_WK = CVDate(Format$(Year(strSyouyoKijitu_WK) + 1, "0000") & "/" & Format$(varSyouyoDate1, "mm/dd"))
'                                    End If
'*20031030
                                Next i
                                '* 最終返済での利息計算
                                strHensaiKikan_WK = DateDiff("y", CVDate(strZenkaiSyouyo), CVDate(strSyouyoKijitu_WK))
                                    
                                '/*利息算出 融資日が新システム移行後(2001/11/01) */                                                    -- 10/23 UPD
                                If CDate(Format(strYuusibi, "YYYY/MM/DD")) >= CDate(Format(gcnsstrSysChng, "YYYY/MM/DD")) Then
                                    dblKeiyakuriritu = Fix(dblRiritu / 365 * 1000000) / 1000000
                                    curRisoku = Fix(curZandaka * dblKeiyakuriritu * strHensaiKikan_WK)
                                Else
                                    curRisoku = Int(curZandaka * dblRiritu * strHensaiKikan_WK / 365)
                                End If
                                
                                '* 最終返済での返済額
                                curSaisyuuHensai = curRisoku + curZandaka
                                '* 今回のループの毎回返済額と、最終返済額の比較
                                If curTeigaku0_WK < curSaisyuuHensai Then
                                    curTeigaku = curTeigaku0_WK
                                Else
                                    '* 今回のループの毎回返済額が、最終返済額より大きくなった場合、
                                    '* 計算終了 −−＞ １回前の金額を毎回返済額とする
                                    Exit Do
                                End If
                            Loop
                            curTeigaku0_WK = curTeigaku
                        End If
                    Else
                        '* 最終返済額より、標準関数で求めた毎回返済額が大きい場合
                        '*********************************************************
                        '* 毎回返済額が１０００円以上の場合、ループの回数を減らすため
                        '* 標準関数で求めた毎回返済額を−１０００円ずつしながら、
                        '* 最終返済額を計算し、最終返済額が算出した毎回返済額よりも
                        '* 小さくなった金額を求める
                        '* （賞与の場合、誤差が大きいのでこの処理を追加する。
                        '* 　給与の場合は誤差が少ないのでこの処理はない。）
                        '*********************************************************
                        If Int(curTeigaku0_WK / 1000) >= 1 Then
                            Do
                                '* 毎回返済額を１円減額
                                curTeigaku0_WK = curTeigaku0_WK - 1000
                                strZenkaiSyouyo = CVDate(DateAdd("y", -1, CVDate(strYuusibi)))
                                strSyouyoKijitu_WK = CVDate(strDaiitiSyouyo)
                                curZandaka = lngSyouyo
                                For i = 1 To intSyouyoKaisuu_WK - 1
                                    strHensaiKikan_WK = DateDiff("y", CVDate(strZenkaiSyouyo), CVDate(strSyouyoKijitu_WK))
                                    
                                    '/*利息算出 融資日が新システム移行後(2001/11/01) */                                                    -- 10/23 UPD
                                    If CDate(Format(strYuusibi, "YYYY/MM/DD")) >= CDate(Format(gcnsstrSysChng, "YYYY/MM/DD")) Then
                                        dblKeiyakuriritu = Fix(dblRiritu / 365 * 1000000) / 1000000
                                        curRisoku = Fix(curZandaka * dblKeiyakuriritu * strHensaiKikan_WK)
                                    Else
                                        curRisoku = Int(curZandaka * dblRiritu * strHensaiKikan_WK / 365)
                                    End If
                                    
                                    curZandaka = curZandaka - (curTeigaku0_WK - curRisoku)
                                    strZenkaiSyouyo = strSyouyoKijitu_WK
                                    '* 次回の賞与日の計算
'*20031030
'次賞与が年度をまたぐ場合「* 最終返済での利息計算」にて、日付がマイナスになる不具合を修正
                                    If Year(varSyouyoDate1) <> Year(varSyouyoDate2) Then
                                        '年度をまたぐ場合
                                        If Month(strSyouyoKijitu_WK) = Month(varSyouyoDate1) Then
                                            '次賞与が夏季の時年度に１追加
                                            strSyouyoKijitu_WK = CVDate(Format$(Year(strSyouyoKijitu_WK) + 1, "0000") & "/" & Format$(varSyouyoDate2, "mm/dd"))
                                        Else
                                            '次賞与は冬季の時は年度は変わらず
                                            strSyouyoKijitu_WK = CVDate(Format$(strSyouyoKijitu_WK, "yyyy/") & Format$(varSyouyoDate1, "mm/dd"))
                                        End If
                                    Else
                                        '年度をまたがない場合
                                        If Month(strSyouyoKijitu_WK) = Month(varSyouyoDate1) Then
                                            '次賞与は冬季の時は年度は変わらず
                                            strSyouyoKijitu_WK = CVDate(Format$(strSyouyoKijitu_WK, "yyyy/") & Format$(varSyouyoDate2, "mm/dd"))
                                        Else
                                            '次賞与が夏季の時年度に１追加
                                            strSyouyoKijitu_WK = CVDate(Format$(Year(strSyouyoKijitu_WK) + 1, "0000") & "/" & Format$(varSyouyoDate1, "mm/dd"))
                                        End If
                                    End If
'                                    If Month(strSyouyoKijitu_WK) = Month(varSyouyoDate1) Then
'                                        strSyouyoKijitu_WK = CVDate(Format$(strSyouyoKijitu_WK, "yyyy/") & Format$(varSyouyoDate2, "mm/dd"))
'                                    Else
'                                        strSyouyoKijitu_WK = CVDate(Format$(Year(strSyouyoKijitu_WK) + 1, "0000") & "/" & Format$(varSyouyoDate1, "mm/dd"))
'                                    End If
'*20031030

                                Next i
                                '* 最終返済での利息計算
                                strHensaiKikan_WK = DateDiff("y", CVDate(strZenkaiSyouyo), CVDate(strSyouyoKijitu_WK))
                                
                                '/*利息算出 融資日が新システム移行後(2001/11/01) */                                                    -- 10/23 UPD
                                If CDate(Format(strYuusibi, "YYYY/MM/DD")) >= CDate(Format(gcnsstrSysChng, "YYYY/MM/DD")) Then
                                    dblKeiyakuriritu = Fix(dblRiritu / 365 * 1000000) / 1000000
                                    curRisoku = Fix(curZandaka * dblKeiyakuriritu * strHensaiKikan_WK)
                                Else
                                    curRisoku = Int(curZandaka * dblRiritu * strHensaiKikan_WK / 365)
                                End If
                                
                                '* 最終返済での返済額
                                curSaisyuuHensai = curRisoku + curZandaka
                                '* 今回のループの毎回返済額と、最終返済額の比較
                                If curTeigaku0_WK <= curSaisyuuHensai Then
                                    '* 今回のループの毎回返済額が、最終返済額以下になった場合、
                                    '* 計算終了 −−＞ 今回の金額を毎回返済額とする
                                    curTeigaku = curTeigaku0_WK
                                    Exit Do
                                End If
                            Loop
                            curTeigaku0_WK = curTeigaku
                        End If
                    End If
                    '*********************************************************
                    '* 上記で求めた毎回返済額を＋１円ずつしながら、
                    '* 最終返済額を計算し、最も近い金額を算出する
                    '* （但し、毎回返済額 <= 最終返済額 となる金額）
                    '*********************************************************
                    curTeigaku = curTeigaku0_WK
                    Do
                        '* 毎回返済額を１円増額
                        curTeigaku0_WK = curTeigaku0_WK + 1
                        strZenkaiSyouyo = CVDate(DateAdd("y", -1, CVDate(strYuusibi)))
                        strSyouyoKijitu_WK = CVDate(strDaiitiSyouyo)
                        curZandaka = lngSyouyo
                        For i = 1 To intSyouyoKaisuu_WK - 1
                            strHensaiKikan_WK = DateDiff("y", CVDate(strZenkaiSyouyo), CVDate(strSyouyoKijitu_WK))
                            
                            '/*利息算出 融資日が新システム移行後(2001/11/01) */                                                    -- 10/23 UPD
                            If CDate(Format(strYuusibi, "YYYY/MM/DD")) >= CDate(Format(gcnsstrSysChng, "YYYY/MM/DD")) Then
                                dblKeiyakuriritu = Fix(dblRiritu / 365 * 1000000) / 1000000
                                curRisoku = Fix(curZandaka * dblKeiyakuriritu * strHensaiKikan_WK)
                            Else
                                curRisoku = Int(curZandaka * dblRiritu * strHensaiKikan_WK / 365)
                            End If
                            
                            curZandaka = curZandaka - (curTeigaku0_WK - curRisoku)
                            strZenkaiSyouyo = strSyouyoKijitu_WK
                            '* 次回の賞与日の計算
'*20031030
'次賞与が年度をまたぐ場合「* 最終返済での利息計算」にて、日付がマイナスになる不具合を修正
                            If Year(varSyouyoDate1) <> Year(varSyouyoDate2) Then
                                '年度をまたぐ場合
                                If Month(strSyouyoKijitu_WK) = Month(varSyouyoDate1) Then
                                    '次賞与が夏季の時年度に１追加
                                    strSyouyoKijitu_WK = CVDate(Format$(Year(strSyouyoKijitu_WK) + 1, "0000") & "/" & Format$(varSyouyoDate2, "mm/dd"))
                                Else
                                    '次賞与は冬季の時は年度は変わらず
                                    strSyouyoKijitu_WK = CVDate(Format$(strSyouyoKijitu_WK, "yyyy/") & Format$(varSyouyoDate1, "mm/dd"))
                                End If
                            Else
                                '年度をまたがない場合
                                If Month(strSyouyoKijitu_WK) = Month(varSyouyoDate1) Then
                                    '次賞与は冬季の時は年度は変わらず
                                    strSyouyoKijitu_WK = CVDate(Format$(strSyouyoKijitu_WK, "yyyy/") & Format$(varSyouyoDate2, "mm/dd"))
                                Else
                                    '次賞与が夏季の時年度に１追加
                                    strSyouyoKijitu_WK = CVDate(Format$(Year(strSyouyoKijitu_WK) + 1, "0000") & "/" & Format$(varSyouyoDate1, "mm/dd"))
                                End If
                            End If

'                            If Month(strSyouyoKijitu_WK) = Month(varSyouyoDate1) Then
'                                strSyouyoKijitu_WK = CVDate(Format$(strSyouyoKijitu_WK, "yyyy/") & Format$(varSyouyoDate2, "mm/dd"))
'                            Else
'                                strSyouyoKijitu_WK = CVDate(Format$(Year(strSyouyoKijitu_WK) + 1, "0000") & "/" & Format$(varSyouyoDate1, "mm/dd"))
'                            End If
'*20031030

                        Next i
                        '* 最終返済での利息計算
                        strHensaiKikan_WK = DateDiff("y", CVDate(strZenkaiSyouyo), CVDate(strSyouyoKijitu_WK))
                        
                        '/*利息算出 融資日が新システム移行後(2001/11/01) */                                                    -- 10/23 UPD
                        If CDate(Format(strYuusibi, "YYYY/MM/DD")) >= CDate(Format(gcnsstrSysChng, "YYYY/MM/DD")) Then
                            dblKeiyakuriritu = Fix(dblRiritu / 365 * 1000000) / 1000000
                            curRisoku = Fix(curZandaka * dblKeiyakuriritu * strHensaiKikan_WK)
                        Else
                            curRisoku = Int(curZandaka * dblRiritu * strHensaiKikan_WK / 365)
                        End If
                        
                        '* 最終返済での返済額
                        curSaisyuuHensai = curRisoku + curZandaka
                        '* 今回のループの毎回返済額と、最終返済額の比較
                        If curTeigaku0_WK = curSaisyuuHensai Then
                            '* 今回のループの毎回返済額と最終返済額が等しく場合、
                            '* 今回の金額を毎回返済額とする
                            curTeigaku = curTeigaku0_WK
                            Exit Do
                        Else
                            If curTeigaku0_WK < curSaisyuuHensai Then
                                curTeigaku = curTeigaku0_WK
                            
                            Else
                                '* 今回のループの毎回返済額が、最終返済額より大きくなった場合、
                                '* 計算終了 −−＞ １回前の金額を毎回返済額とする
                                Exit Do
                            End If
                        End If
                    Loop
                End If
                lngSyouyoTeigaku_WK = curTeigaku
            End If
        End If
    End If
  
    gfncstrKeisan = 0
    Select Case intHensaiFlg
        Case 1: gfncstrKeisan = lngKyuuyoTeigaku_WK
        Case 2: gfncstrKeisan = lngSyouyoTeigaku_WK
    End Select

End Function
